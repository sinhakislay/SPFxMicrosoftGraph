{"version":3,"file":"certificates.js","sourceRoot":"","sources":["../src/certificates.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\n/// <reference path=\"./NodeForgeExtensions.d.ts\" />\r\n\r\nimport { GulpTask } from '@microsoft/gulp-core-build';\r\nimport { FileSystem } from '@microsoft/node-core-library';\r\nimport * as forgeType from 'node-forge';\r\nconst forge: typeof forgeType & IForgeExtensions = require('node-forge');\r\nimport * as path from 'path';\r\nimport * as child_process from 'child_process';\r\nimport { EOL } from 'os';\r\n\r\nimport { runSudoSync, ISudoSyncResult } from './sudoSync';\r\nimport { CertificateStore } from './CertificateStore';\r\n\r\nconst serialNumber: string = '731c321744e34650a202e3ef91c3c1b9';\r\nconst friendlyName: string = 'gulp-core-build-serve Development Certificate';\r\nconst macKeychain: string = '/Library/Keychains/System.keychain';\r\n\r\nlet _certutilExePath: string;\r\n\r\nexport interface ICertificate {\r\n  pemCertificate: string;\r\n  pemKey: string;\r\n}\r\n\r\nfunction _createDevelopmentCertificate(): ICertificate {\r\n  const keys: forgeType.pki.KeyPair = forge.pki.rsa.generateKeyPair(2048);\r\n  const certificate: IForgeCertificate = forge.pki.createCertificate();\r\n  certificate.publicKey = keys.publicKey;\r\n\r\n  certificate.serialNumber = serialNumber;\r\n\r\n  const now: Date = new Date();\r\n  certificate.validity.notBefore = now;\r\n  certificate.validity.notAfter.setFullYear(certificate.validity.notBefore.getFullYear() + 3); // Three years from now\r\n\r\n  const attrs: IAttr[] = [{\r\n    name: 'commonName',\r\n    value: 'localhost'\r\n  }];\r\n\r\n  certificate.setSubject(attrs);\r\n  certificate.setIssuer(attrs);\r\n\r\n  certificate.setExtensions([\r\n    {\r\n      name: 'subjectAltName',\r\n      altNames: [{\r\n        type: 2, // DNS\r\n        value: 'localhost'\r\n      }]\r\n    },\r\n    {\r\n      name: 'keyUsage',\r\n      digitalSignature: true,\r\n      keyEncipherment: true,\r\n      dataEncipherment: true\r\n    }, {\r\n      name: 'extKeyUsage',\r\n      serverAuth: true\r\n    }, {\r\n      name: 'friendlyName',\r\n      value: friendlyName\r\n    }]);\r\n\r\n  // self-sign certificate\r\n  certificate.sign(keys.privateKey, forge.md.sha256.create());\r\n\r\n  // convert a Forge certificate to PEM\r\n  const pem: string = forge.pki.certificateToPem(certificate);\r\n  const privateKey: string = forge.pki.privateKeyToPem(keys.privateKey);\r\n\r\n  return {\r\n    pemCertificate: pem,\r\n    pemKey: privateKey\r\n  };\r\n}\r\n\r\nfunction _ensureCertUtilExePath(parentTask: GulpTask<{}>): string {\r\n  if (!_certutilExePath) {\r\n    const where: child_process.SpawnSyncReturns<string> = child_process.spawnSync('where', ['certutil']);\r\n\r\n    const whereErr: string = where.stderr.toString();\r\n    if (!!whereErr) {\r\n      parentTask.logError(`Error finding certUtil command: \"${whereErr}\"`);\r\n      _certutilExePath = undefined;\r\n    } else {\r\n      const lines: string[] = where.stdout.toString().trim().split(EOL);\r\n      _certutilExePath = lines[0].trim();\r\n    }\r\n  }\r\n\r\n  return _certutilExePath;\r\n}\r\n\r\nfunction _tryTrustCertificate(certificatePath: string, parentTask: GulpTask<{}>): boolean {\r\n  switch (process.platform) {\r\n    case 'win32':\r\n      const certutilExePath: string = _ensureCertUtilExePath(parentTask);\r\n      if (!certutilExePath) {\r\n        // Unable to find the cert utility\r\n        return false;\r\n      }\r\n\r\n      parentTask.log( 'Attempting to trust a dev certificate. This self-signed certificate only points to localhost ' +\r\n                      'and will be stored in your local user profile to be used by other instances of ' +\r\n                      'gulp-core-build-serve. If you do not consent to trust this certificate, click \"NO\" in the ' +\r\n                      'dialog.');\r\n\r\n      const winTrustResult: child_process.SpawnSyncReturns<string> =\r\n        child_process.spawnSync(certutilExePath, ['-user', '-addstore', 'root', certificatePath]);\r\n\r\n      if (winTrustResult.status !== 0) {\r\n        parentTask.logError(`Error: ${winTrustResult.stdout.toString()}`);\r\n\r\n        const errorLines: string[] = winTrustResult.stdout.toString().split(EOL).map((line: string) => line.trim());\r\n\r\n        // Not sure if this is always the status code for \"cancelled\" - should confirm.\r\n        if (winTrustResult.status === 2147943623 ||\r\n            errorLines[errorLines.length - 1].indexOf('The operation was canceled by the user.') > 0) {\r\n          parentTask.log('Certificate trust cancelled.');\r\n        } else {\r\n          parentTask.logError('Certificate trust failed with an unknown error.');\r\n        }\r\n\r\n        return false;\r\n      } else {\r\n        parentTask.logVerbose('Successfully trusted development certificate.');\r\n\r\n        return true;\r\n      }\r\n\r\n    case 'darwin': // tslint:disable-line:no-switch-case-fall-through\r\n      parentTask.log( 'Attempting to trust a dev certificate. This self-signed certificate only points to localhost ' +\r\n                      'and will be stored in your local user profile to be used by other instances of ' +\r\n                      'gulp-core-build-serve. If you do not consent to trust this certificate, do not enter your ' +\r\n                      'root password in the prompt.');\r\n\r\n      const commands: string[] = [\r\n        'security',\r\n        'add-trusted-cert',\r\n        '-d',\r\n        '-r',\r\n        'trustRoot',\r\n        '-k',\r\n        macKeychain,\r\n        certificatePath\r\n      ];\r\n      const result: ISudoSyncResult = runSudoSync(commands);\r\n\r\n      if (result.code === 0) {\r\n        parentTask.logVerbose('Successfully trusted development certificate.');\r\n        return true;\r\n      } else {\r\n        if (result.stderr.some((value: string) => !!value.match(/The authorization was cancelled by the user\\./))) {\r\n          parentTask.log('Certificate trust cancelled.');\r\n          return false;\r\n        } else {\r\n          parentTask.logError(`Certificate trust failed with an unknown error. Exit code: ${result.code}. ` +\r\n                              `Error: ${result.stderr.join(' ')}`);\r\n          return false;\r\n        }\r\n      }\r\n\r\n    default: // tslint:disable-line:no-switch-case-fall-through\r\n      // Linux + others: Have the user manually trust the cert if they want to\r\n      parentTask.log( 'Automatic certificate trust is only implemented for gulp-core-build-serve on Windows and ' +\r\n                      'macOS. To trust the development certificate, add this certificate to your trusted root ' +\r\n                      `certification authorities: \"${CertificateStore.instance.certificatePath}\".`);\r\n      return true;\r\n  }\r\n}\r\n\r\nfunction _trySetFriendlyName(certificatePath: string, parentTask: GulpTask<{}>): boolean {\r\n  if (process.platform === 'win32') {\r\n    const certutilExePath: string = _ensureCertUtilExePath(parentTask);\r\n    if (!certutilExePath) {\r\n      // Unable to find the cert utility\r\n      return false;\r\n    }\r\n\r\n    const basePath: string = path.dirname(certificatePath);\r\n    const fileName: string = path.basename(certificatePath, path.extname(certificatePath));\r\n    const friendlyNamePath: string = path.join(basePath, `${fileName}.inf`);\r\n\r\n    const friendlyNameFile: string = [\r\n      '[Version]',\r\n      'Signature = \"$Windows NT$\"',\r\n      '[Properties]',\r\n      `11 = \"{text}${friendlyName}\"`,\r\n      ''\r\n    ].join(EOL);\r\n\r\n    FileSystem.writeFile(friendlyNamePath, friendlyNameFile);\r\n\r\n    const commands: string[] = [\r\n      '–repairstore',\r\n      '–user',\r\n      'root',\r\n      serialNumber,\r\n      friendlyNamePath\r\n    ];\r\n    const repairStoreResult: child_process.SpawnSyncReturns<string> =\r\n      child_process.spawnSync(certutilExePath, commands);\r\n\r\n    if (repairStoreResult.status !== 0) {\r\n      parentTask.logError(`CertUtil Error: ${repairStoreResult.stdout.toString()}`);\r\n\r\n      return false;\r\n    } else {\r\n      parentTask.logVerbose('Successfully set certificate name.');\r\n\r\n      return true;\r\n    }\r\n  } else {\r\n    // No equivalent concept outside of Windows\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * Get the dev certificate from the store, or, optionally, generate a new one and trust it if one doesn't exist in the\r\n *  store.\r\n */\r\nexport function ensureCertificate<TGulpTask>(\r\n  canGenerateNewCertificate: boolean,\r\n  parentTask: GulpTask<TGulpTask>\r\n): ICertificate {\r\n  const certificateStore: CertificateStore = CertificateStore.instance;\r\n\r\n  if (certificateStore.certificateData && certificateStore.keyData) {\r\n    if (!_certificateHasSubjectAltName(certificateStore.certificateData)) {\r\n      let warningMessage: string = 'The existing development certificate is missing the subjectAltName ' +\r\n                                    'property and will not work with the latest versions of some browsers. ';\r\n\r\n      if (canGenerateNewCertificate) {\r\n        warningMessage += ' Attempting to untrust the certificate and generate a new one.';\r\n      } else {\r\n        warningMessage += ' Untrust the certificate and generate a new one.';\r\n      }\r\n\r\n      parentTask.logWarning(warningMessage);\r\n\r\n      if (canGenerateNewCertificate) {\r\n        untrustCertificate(parentTask);\r\n        _ensureCertificateInternal(parentTask);\r\n      }\r\n    }\r\n  } else if (canGenerateNewCertificate) {\r\n    _ensureCertificateInternal(parentTask);\r\n  }\r\n\r\n  return {\r\n    pemCertificate: certificateStore.certificateData,\r\n    pemKey: certificateStore.keyData\r\n  };\r\n}\r\n\r\nexport function untrustCertificate<TGulpTask>(parentTask: GulpTask<TGulpTask>): boolean {\r\n  switch (process.platform) {\r\n    case 'win32':\r\n      const certutilExePath: string = _ensureCertUtilExePath(parentTask);\r\n      if (!certutilExePath) {\r\n        // Unable to find the cert utility\r\n        return false;\r\n      }\r\n\r\n      const winUntrustResult: child_process.SpawnSyncReturns<string> =\r\n        child_process.spawnSync(certutilExePath, ['-user', '-delstore', 'root', serialNumber]);\r\n\r\n      if (winUntrustResult.status !== 0) {\r\n        parentTask.logError(`Error: ${winUntrustResult.stdout.toString()}`);\r\n        return false;\r\n      } else {\r\n        parentTask.logVerbose('Successfully untrusted development certificate.');\r\n        return true;\r\n      }\r\n\r\n    case 'darwin': // tslint:disable-line:no-switch-case-fall-through\r\n      parentTask.logVerbose('Trying to find the signature of the dev cert');\r\n\r\n      const macFindCertificateResult: child_process.SpawnSyncReturns<string> =\r\n        child_process.spawnSync('security', ['find-certificate', '-c', 'localhost', '-a', '-Z', macKeychain]);\r\n\r\n      if (macFindCertificateResult.status !== 0) {\r\n        parentTask.logError(`Error finding the dev certificate: ${macFindCertificateResult.output.join(' ')}`);\r\n        return false;\r\n      }\r\n\r\n      const outputLines: string[] = macFindCertificateResult.stdout.toString().split(EOL);\r\n      let found: boolean = false;\r\n      let shaHash: string = undefined;\r\n      for (let i: number = 0; i < outputLines.length; i++) {\r\n        const line: string = outputLines[i];\r\n        const shaMatch: string[] = line.match(/^SHA-1 hash: (.+)$/);\r\n        if (shaMatch) {\r\n          shaHash = shaMatch[1];\r\n        }\r\n\r\n        const snbrMatch: string[] = line.match(/^\\s*\"snbr\"<blob>=0x([^\\s]+).+$/);\r\n        if (snbrMatch && (snbrMatch[1] || '').toLowerCase() === serialNumber) {\r\n          found = true;\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (!found) {\r\n        parentTask.logError('Unable to find the dev certificate.');\r\n        return false;\r\n      }\r\n\r\n      parentTask.logVerbose(`Found the dev cert. SHA is ${shaHash}`);\r\n\r\n      const macUntrustResult: ISudoSyncResult =\r\n        runSudoSync(['security', 'delete-certificate', '-Z', shaHash, macKeychain]);\r\n\r\n      if (macUntrustResult.code === 0) {\r\n        parentTask.logVerbose('Successfully untrusted dev certificate.');\r\n        return true;\r\n      } else {\r\n        parentTask.logError(macUntrustResult.stderr.join(' '));\r\n        return false;\r\n      }\r\n\r\n    default: // tslint:disable-line:no-switch-case-fall-through\r\n      // Linux + others: Have the user manually untrust the cert\r\n      parentTask.log( 'Automatic certificate untrust is only implemented for gulp-core-build-serve on Windows and ' +\r\n                      'macOS. To untrust the development certificate, remove this certificate from your trusted ' +\r\n                      `root certification authorities: \"${CertificateStore.instance.certificatePath}\". The ` +\r\n                      `certificate has serial number \"${serialNumber}\".`);\r\n      return false;\r\n  }\r\n}\r\n\r\nfunction _ensureCertificateInternal(parentTask: GulpTask<{}>): void {\r\n  const certificateStore: CertificateStore = CertificateStore.instance;\r\n  const generatedCertificate: ICertificate = _createDevelopmentCertificate();\r\n\r\n  const now: Date = new Date();\r\n  const certificateName: string = now.getTime().toString();\r\n  const tempDirName: string = path.join(__dirname, '..', 'temp');\r\n\r\n  const tempCertificatePath: string = path.join(tempDirName, `${certificateName}.cer`);\r\n  FileSystem.writeFile(tempCertificatePath, generatedCertificate.pemCertificate, {\r\n    ensureFolderExists: true\r\n  });\r\n\r\n  if (_tryTrustCertificate(tempCertificatePath, parentTask)) {\r\n    certificateStore.certificateData = generatedCertificate.pemCertificate;\r\n    certificateStore.keyData = generatedCertificate.pemKey;\r\n\r\n    if (!_trySetFriendlyName(tempCertificatePath, parentTask)) { // Try to set the friendly name, and warn if we can't\r\n      parentTask.logWarning('Unable to set the certificate\\'s friendly name.');\r\n    }\r\n  } else {\r\n    // Clear out the existing store data, if any exists\r\n    certificateStore.certificateData = undefined;\r\n    certificateStore.keyData = undefined;\r\n  }\r\n\r\n  FileSystem.deleteFile(tempCertificatePath);\r\n}\r\n\r\nfunction _certificateHasSubjectAltName(certificateData: string): boolean {\r\n  const certificate: IForgeCertificate = forge.pki.certificateFromPem(certificateData);\r\n  return !!certificate.getExtension('subjectAltName');\r\n}\r\n"]}