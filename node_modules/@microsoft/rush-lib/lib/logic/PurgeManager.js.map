{"version":3,"file":"PurgeManager.js","sourceRoot":"","sources":["../../src/logic/PurgeManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as colors from 'colors';\r\nimport * as path from 'path';\r\n\r\nimport { AsyncRecycler } from '../utilities/AsyncRecycler';\r\nimport { RushConfiguration } from '../api/RushConfiguration';\r\nimport { RushConstants } from '../logic/RushConstants';\r\nimport { RushGlobalFolder } from '../api/RushGlobalFolder';\r\n\r\n/**\r\n * This class implements the logic for \"rush purge\"\r\n */\r\nexport class PurgeManager {\r\n  private _rushConfiguration: RushConfiguration;\r\n  private _rushGlobalFolder: RushGlobalFolder;\r\n  private _commonTempFolderRecycler: AsyncRecycler;\r\n  private _rushUserFolderRecycler: AsyncRecycler;\r\n\r\n  public constructor(rushConfiguration: RushConfiguration, rushGlobalFolder: RushGlobalFolder) {\r\n    this._rushConfiguration = rushConfiguration;\r\n    this._rushGlobalFolder = rushGlobalFolder;\r\n\r\n    const commonAsyncRecyclerPath: string = path.join(\r\n      this._rushConfiguration.commonTempFolder,\r\n      RushConstants.rushRecyclerFolderName\r\n    );\r\n    this._commonTempFolderRecycler = new AsyncRecycler(commonAsyncRecyclerPath);\r\n\r\n    const rushUserAsyncRecyclerPath: string = path.join(\r\n      this._rushGlobalFolder.path,\r\n      RushConstants.rushRecyclerFolderName\r\n    );\r\n    this._rushUserFolderRecycler = new AsyncRecycler(rushUserAsyncRecyclerPath);\r\n  }\r\n\r\n  /**\r\n   * Performs the AsyncRecycler.deleteAll() operation.  This should be called before\r\n   * the PurgeManager instance is disposed.\r\n   */\r\n  public deleteAll(): void {\r\n    this._commonTempFolderRecycler.deleteAll();\r\n    this._rushUserFolderRecycler.deleteAll();\r\n  }\r\n\r\n  public get commonTempFolderRecycler(): AsyncRecycler {\r\n    return this._commonTempFolderRecycler;\r\n  }\r\n\r\n  /**\r\n   * Delete everything from the common/temp folder\r\n   */\r\n  public purgeNormal(): void {\r\n    // Delete everything under common\\temp except for the recycler folder itself\r\n    console.log('Purging ' + this._rushConfiguration.commonTempFolder);\r\n\r\n    this._commonTempFolderRecycler.moveAllItemsInFolder(this._rushConfiguration.commonTempFolder,\r\n      this._getMembersToExclude(this._rushConfiguration.commonTempFolder, true));\r\n  }\r\n\r\n  /**\r\n   * In addition to performing the purgeNormal() operation, this method also cleans the\r\n   * .rush folder in the user's home directory.\r\n   */\r\n  public purgeUnsafe(): void {\r\n    this.purgeNormal();\r\n\r\n    // We will delete everything under ~/.rush/ except for the recycler folder itself\r\n    console.log('Purging ' + this._rushGlobalFolder.path);\r\n\r\n    // If Rush itself is running under a folder such as  ~/.rush/node-v4.5.6/rush-1.2.3,\r\n    // we cannot delete that folder.\r\n\r\n    // First purge the node-specific folder, e.g. ~/.rush/node-v4.5.6/* except for rush-1.2.3:\r\n    this._rushUserFolderRecycler.moveAllItemsInFolder(this._rushGlobalFolder.nodeSpecificPath,\r\n      this._getMembersToExclude(this._rushGlobalFolder.nodeSpecificPath, true));\r\n\r\n    // Then purge the the global folder, e.g. ~/.rush/* except for node-v4.5.6\r\n    this._rushUserFolderRecycler.moveAllItemsInFolder(this._rushGlobalFolder.path,\r\n      this._getMembersToExclude(this._rushGlobalFolder.path, false));\r\n  }\r\n\r\n  private _getMembersToExclude(folderToRecycle: string, showWarning: boolean): string[] {\r\n    // Don't recycle the recycler\r\n    const membersToExclude: string[] = [RushConstants.rushRecyclerFolderName];\r\n\r\n    // If the current process is running inside one of the folders, don't recycle that either\r\n    // Example: \"/home/user/.rush/rush-1.2.3/lib/example.js\"\r\n    const currentFolderPath: string = path.resolve(__dirname);\r\n\r\n    // Example:\r\n    // folderToRecycle = \"/home/user/.rush/node-v4.5.6\"\r\n    // relative =  \"rush-1.2.3/lib/example.js\"\r\n    const relative: string = path.relative(folderToRecycle, currentFolderPath);\r\n\r\n    // (The result can be an absolute path if the two folders are on different drive letters)\r\n    if (!path.isAbsolute(relative)) {\r\n      // Get the first path segment:\r\n      const firstPart: string = relative.split(/[\\\\\\/]/)[0];\r\n      if (firstPart.length > 0 && firstPart !== '..') {\r\n        membersToExclude.push(firstPart);\r\n\r\n        if (showWarning) {\r\n          // Warn that we won't dispose this folder\r\n          console.log(colors.yellow('The active process\\'s folder will not be deleted: '\r\n            + path.join(folderToRecycle, firstPart)));\r\n        }\r\n      }\r\n    }\r\n\r\n    return membersToExclude;\r\n  }\r\n}\r\n"]}