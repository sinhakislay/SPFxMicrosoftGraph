{"version":3,"file":"InstallManager.js","sourceRoot":"","sources":["../../src/logic/InstallManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as glob from 'glob';\r\nimport * as colors from 'colors';\r\nimport * as fetch from 'node-fetch';\r\nimport * as http from 'http';\r\nimport HttpsProxyAgent = require('https-proxy-agent');\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport * as semver from 'semver';\r\nimport * as tar from 'tar';\r\nimport globEscape = require('glob-escape');\r\nimport {\r\n  JsonFile,\r\n  LockFile,\r\n  Text,\r\n  IPackageJson,\r\n  MapExtensions,\r\n  FileSystem,\r\n  FileConstants,\r\n  Sort,\r\n  PosixModeBits\r\n} from '@microsoft/node-core-library';\r\n\r\nimport { ApprovedPackagesChecker } from '../logic/ApprovedPackagesChecker';\r\nimport { AsyncRecycler } from '../utilities/AsyncRecycler';\r\nimport { BaseLinkManager } from '../logic/base/BaseLinkManager';\r\nimport { BaseShrinkwrapFile } from '../logic/base/BaseShrinkwrapFile';\r\nimport { PolicyValidator } from '../logic/policy/PolicyValidator';\r\nimport { IRushTempPackageJson } from '../logic/base/BasePackage';\r\nimport { Git } from '../logic/Git';\r\nimport { LastInstallFlag } from '../api/LastInstallFlag';\r\nimport { LinkManagerFactory } from '../logic/LinkManagerFactory';\r\nimport { PurgeManager } from './PurgeManager';\r\nimport { RushConfiguration, ICurrentVariantJson } from '../api/RushConfiguration';\r\nimport { RushConfigurationProject } from '../api/RushConfigurationProject';\r\nimport { RushConstants } from '../logic/RushConstants';\r\nimport { ShrinkwrapFileFactory } from '../logic/ShrinkwrapFileFactory';\r\nimport { Stopwatch } from '../utilities/Stopwatch';\r\nimport { Utilities } from '../utilities/Utilities';\r\nimport { Rush } from '../api/Rush';\r\nimport { PackageJsonEditor, DependencyType, PackageJsonDependency } from '../api/PackageJsonEditor';\r\nimport { AlreadyReportedError } from '../utilities/AlreadyReportedError';\r\nimport { CommonVersionsConfiguration } from '../api/CommonVersionsConfiguration';\r\n\r\n// The PosixModeBits are intended to be used with bitwise operations.\r\n// tslint:disable:no-bitwise\r\n\r\nconst MAX_INSTALL_ATTEMPTS: number = 2;\r\n\r\n/**\r\n * The \"noMtime\" flag is new in tar@4.4.1 and not available yet for \\@types/tar.\r\n * As a temporary workaround, augment the type.\r\n */\r\nimport { CreateOptions } from 'tar';\r\nimport { RushGlobalFolder } from '../api/RushGlobalFolder';\r\nimport { PackageManagerName } from '../api/packageManager/PackageManager';\r\nimport { PnpmPackageManager } from '../api/packageManager/PnpmPackageManager';\r\nimport { DependencySpecifier } from './DependencySpecifier';\r\n\r\nexport interface CreateOptions { // tslint:disable-line:interface-name\r\n  /**\r\n   * \"Set to true to omit writing mtime values for entries. Note that this prevents using other\r\n   * mtime-based features like tar.update or the keepNewer option with the resulting tar archive.\"\r\n   */\r\n  noMtime?: boolean;\r\n}\r\n\r\nexport interface IInstallManagerOptions {\r\n  /**\r\n   * Whether the global \"--debug\" flag was specified.\r\n   */\r\n  debug: boolean;\r\n  /**\r\n   * Whether or not Rush will automatically update the shrinkwrap file.\r\n   * True for \"rush update\", false for \"rush install\".\r\n   */\r\n  allowShrinkwrapUpdates: boolean;\r\n  /**\r\n   * Whether to skip policy checks.\r\n   */\r\n  bypassPolicy: boolean;\r\n  /**\r\n   * Whether to skip linking, i.e. require \"rush link\" to be done manually later.\r\n   */\r\n  noLink: boolean;\r\n  /**\r\n   * Whether to delete the shrinkwrap file before installation, i.e. so that all dependenices\r\n   * will be upgraded to the latest SemVer-compatible version.\r\n   */\r\n  fullUpgrade: boolean;\r\n  /**\r\n   * Whether to force an update to the shrinkwrap file even if it appears to be unnecessary.\r\n   * Normally Rush uses heuristics to determine when \"pnpm install\" can be skipped,\r\n   * but sometimes the heuristics can be inaccurate due to external influences\r\n   * (pnpmfile.js script logic, registry changes, etc).\r\n   */\r\n  recheckShrinkwrap: boolean;\r\n\r\n  /**\r\n   * The value of the \"--network-concurrency\" command-line parameter, which\r\n   * is a diagnostic option used to troubleshoot network failures.\r\n   *\r\n   * Currently only supported for PNPM.\r\n   */\r\n  networkConcurrency: number | undefined;\r\n\r\n  /**\r\n   * Whether or not to collect verbose logs from the package manager.\r\n   * If specified when using PNPM, the logs will be in /common/temp/pnpm.log\r\n   */\r\n  collectLogFile: boolean;\r\n\r\n  /**\r\n   * The variant to consider when performing installations and validating shrinkwrap updates.\r\n   */\r\n  variant?: string | undefined;\r\n}\r\n\r\n/**\r\n * This class implements common logic between \"rush install\" and \"rush update\".\r\n */\r\nexport class InstallManager {\r\n  private _rushConfiguration: RushConfiguration;\r\n  private _rushGlobalFolder: RushGlobalFolder;\r\n  private _commonNodeModulesMarker: LastInstallFlag;\r\n  private _commonTempFolderRecycler: AsyncRecycler;\r\n\r\n  private _options: IInstallManagerOptions;\r\n\r\n  /**\r\n   * Returns a map of all direct dependencies that only have a single semantic version specifier.\r\n   * Returns a map: dependency name --> version specifier\r\n   */\r\n  public static collectImplicitlyPreferredVersions(\r\n    rushConfiguration: RushConfiguration,\r\n    options: {\r\n      variant?: string | undefined\r\n    } = {}\r\n  ): Map<string, string> {\r\n    // First, collect all the direct dependencies of all local projects, and their versions:\r\n    // direct dependency name --> set of version specifiers\r\n    const versionsForDependencies: Map<string, Set<string>> = new Map<string, Set<string>>();\r\n\r\n    rushConfiguration.projects.forEach((project: RushConfigurationProject) => {\r\n      InstallManager._collectVersionsForDependencies(\r\n        rushConfiguration,\r\n        {\r\n          versionsForDependencies,\r\n          dependencies: project.packageJsonEditor.dependencyList,\r\n          cyclicDependencies: project.cyclicDependencyProjects,\r\n          variant: options.variant\r\n        });\r\n\r\n      InstallManager._collectVersionsForDependencies(\r\n        rushConfiguration,\r\n        {\r\n          versionsForDependencies,\r\n          dependencies: project.packageJsonEditor.devDependencyList,\r\n          cyclicDependencies: project.cyclicDependencyProjects,\r\n          variant: options.variant\r\n        });\r\n    });\r\n\r\n    // If any dependency has more than one version, then filter it out (since we don't know which version\r\n    // should be preferred).  What remains will be the list of preferred dependencies.\r\n    // dependency --> version specifier\r\n    const implicitlyPreferred: Map<string, string> = new Map<string, string>();\r\n    versionsForDependencies.forEach((versions: Set<string>, dep: string) => {\r\n      if (versions.size === 1) {\r\n        const version: string = versions.values().next().value;\r\n        implicitlyPreferred.set(dep, version);\r\n      }\r\n    });\r\n    return implicitlyPreferred;\r\n  }\r\n\r\n  // Helper for collectImplicitlyPreferredVersions()\r\n  private static _updateVersionsForDependencies(versionsForDependencies: Map<string, Set<string>>,\r\n    dependency: string, version: string): void {\r\n    if (!versionsForDependencies.has(dependency)) {\r\n      versionsForDependencies.set(dependency, new Set<string>());\r\n    }\r\n    versionsForDependencies.get(dependency)!.add(version);\r\n  }\r\n\r\n  // Helper for collectImplicitlyPreferredVersions()\r\n  private static _collectVersionsForDependencies(\r\n    rushConfiguration: RushConfiguration,\r\n    options: {\r\n      versionsForDependencies: Map<string, Set<string>>;\r\n      dependencies: ReadonlyArray<PackageJsonDependency>;\r\n      cyclicDependencies: Set<string>;\r\n      variant: string | undefined;\r\n    }): void {\r\n    const {\r\n      variant,\r\n      dependencies,\r\n      versionsForDependencies,\r\n      cyclicDependencies\r\n    } = options;\r\n\r\n    const commonVersions: CommonVersionsConfiguration = rushConfiguration.getCommonVersions(variant);\r\n\r\n    const allowedAlternativeVersions: Map<string, ReadonlyArray<string>>\r\n      = commonVersions.allowedAlternativeVersions;\r\n\r\n    for (const dependency of dependencies) {\r\n      const alternativesForThisDependency: ReadonlyArray<string>\r\n        = allowedAlternativeVersions.get(dependency.name) || [];\r\n\r\n      // For each dependency, collectImplicitlyPreferredVersions() is collecting the set of all version specifiers\r\n      // that appear across the repo.  If there is only one version specifier, then that's the \"preferred\" one.\r\n      // However, there are a few cases where additional version specifiers can be safely ignored.\r\n      let ignoreVersion: boolean = false;\r\n\r\n      // 1. If the version specifier was listed in \"allowedAlternativeVersions\", then it's never a candidate.\r\n      //    (Even if it's the only version specifier anywhere in the repo, we still ignore it, because\r\n      //    otherwise the rule would be difficult to explain.)\r\n      if (alternativesForThisDependency.indexOf(dependency.version) > 0) {\r\n        ignoreVersion = true;\r\n      } else {\r\n        // Is it a local project?\r\n        const localProject: RushConfigurationProject | undefined = rushConfiguration.getProjectByName(dependency.name);\r\n        if (localProject) {\r\n          // 2. If it's a symlinked local project, then it's not a candidate, because the package manager will\r\n          //    never even see it.\r\n          // However there are two ways that a local project can NOT be symlinked:\r\n          // - if the local project doesn't satisfy the referenced semver specifier; OR\r\n          // - if the local project was specified in \"cyclicDependencyProjects\" in rush.json\r\n          if (semver.satisfies(localProject.packageJsonEditor.version, dependency.version)\r\n            && !cyclicDependencies.has(dependency.name)) {\r\n            ignoreVersion = true;\r\n          }\r\n        }\r\n\r\n        if (!ignoreVersion) {\r\n          InstallManager._updateVersionsForDependencies(versionsForDependencies, dependency.name, dependency.version);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public get commonNodeModulesMarker(): LastInstallFlag {\r\n    return this._commonNodeModulesMarker;\r\n  }\r\n\r\n  constructor(\r\n    rushConfiguration: RushConfiguration,\r\n    rushGlobalFolder: RushGlobalFolder,\r\n    purgeManager: PurgeManager,\r\n    options: IInstallManagerOptions\r\n  ) {\r\n    this._rushConfiguration = rushConfiguration;\r\n    this._rushGlobalFolder = rushGlobalFolder;\r\n    this._commonTempFolderRecycler = purgeManager.commonTempFolderRecycler;\r\n    this._options = options;\r\n\r\n    this._commonNodeModulesMarker = new LastInstallFlag(this._rushConfiguration.commonTempFolder, {\r\n      node: process.versions.node,\r\n      packageManager: rushConfiguration.packageManager,\r\n      packageManagerVersion: rushConfiguration.packageManagerToolVersion\r\n    });\r\n  }\r\n\r\n  public async doInstall(): Promise<void> {\r\n    const options: IInstallManagerOptions = this._options;\r\n\r\n    // Check the policies\r\n    PolicyValidator.validatePolicy(this._rushConfiguration, options.bypassPolicy);\r\n\r\n    // Git hooks are only installed if the repo opts in by including files in /common/git-hooks\r\n    const hookSource: string = path.join(this._rushConfiguration.commonFolder, 'git-hooks');\r\n    const hookDestination: string | undefined = Git.getHooksFolder();\r\n\r\n    if (FileSystem.exists(hookSource) && hookDestination) {\r\n      const hookFilenames: Array<string> = FileSystem.readFolder(hookSource);\r\n      if (hookFilenames.length > 0) {\r\n        console.log(os.EOL + colors.bold('Found files in the \"common/git-hooks\" folder.'));\r\n\r\n        // Clear the currently installed git hooks and install fresh copies\r\n        FileSystem.ensureEmptyFolder(hookDestination);\r\n\r\n        // Only copy files that look like Git hook names\r\n        const filteredHookFilenames: string[] = hookFilenames.filter(x => /^[a-z\\-]+/.test(x));\r\n        for (const filename of filteredHookFilenames) {\r\n          FileSystem.copyFile({\r\n            sourcePath: path.join(hookSource, filename),\r\n            destinationPath: path.join(hookDestination, filename)\r\n          });\r\n          FileSystem.changePosixModeBits(path.join(hookDestination, filename),\r\n            PosixModeBits.UserRead | PosixModeBits.UserExecute);\r\n        }\r\n\r\n        console.log('Successfully installed these Git hook scripts: ' + filteredHookFilenames.join(', ') + os.EOL);\r\n      }\r\n    }\r\n\r\n    const approvedPackagesChecker: ApprovedPackagesChecker = new ApprovedPackagesChecker(this._rushConfiguration);\r\n    if (approvedPackagesChecker.approvedPackagesFilesAreOutOfDate) {\r\n      if (this._options.allowShrinkwrapUpdates) {\r\n        approvedPackagesChecker.rewriteConfigFiles();\r\n        console.log(colors.yellow(\r\n          'Approved package files have been updated. These updates should be committed to source control'\r\n        ));\r\n      } else {\r\n        throw new Error(`Approved packages files are out-of date. Run \"rush update\" to update them.`);\r\n      }\r\n    }\r\n\r\n    // Ensure that the package manager is installed\r\n    await this.ensureLocalPackageManager();\r\n    let shrinkwrapFile: BaseShrinkwrapFile | undefined = undefined;\r\n\r\n    // (If it's a full update, then we ignore the shrinkwrap from Git since it will be overwritten)\r\n    if (!options.fullUpgrade) {\r\n      try {\r\n        shrinkwrapFile = ShrinkwrapFileFactory.getShrinkwrapFile(this._rushConfiguration.packageManager,\r\n          this._rushConfiguration.getCommittedShrinkwrapFilename(options.variant));\r\n      } catch (ex) {\r\n        console.log();\r\n        console.log(`Unable to load the ${this._shrinkwrapFilePhrase}: ${ex.message}`);\r\n\r\n        if (!options.allowShrinkwrapUpdates) {\r\n          console.log();\r\n          console.log(colors.red('You need to run \"rush update\" to fix this problem'));\r\n          throw new AlreadyReportedError();\r\n        }\r\n\r\n        shrinkwrapFile = undefined;\r\n      }\r\n    }\r\n\r\n    // Write a file indicating which variant is being installed.\r\n    // This will be used by bulk scripts to determine the correct Shrinkwrap file to track.\r\n    const currentVariantJsonFilename: string = this._rushConfiguration.currentVariantJsonFilename;\r\n    const currentVariantJson: ICurrentVariantJson = {\r\n      variant: options.variant || null // tslint:disable-line:no-null-keyword\r\n    };\r\n\r\n    // Determine if the variant is already current by updating current-variant.json.\r\n    // If nothing is written, the variant has not changed.\r\n    const variantIsUpToDate: boolean = !JsonFile.save(currentVariantJson, currentVariantJsonFilename, {\r\n      onlyIfChanged: true\r\n    });\r\n\r\n    if (options.variant) {\r\n      console.log();\r\n      console.log(colors.bold(`Using variant '${options.variant}' for installation.`));\r\n    } else if (!variantIsUpToDate && !options.variant) {\r\n      console.log();\r\n      console.log(colors.bold('Using the default variant for installation.'));\r\n    }\r\n\r\n    const shrinkwrapIsUpToDate: boolean = this._createTempModulesAndCheckShrinkwrap({\r\n      shrinkwrapFile,\r\n      variant: options.variant\r\n    }) && !options.recheckShrinkwrap;\r\n\r\n    if (!shrinkwrapIsUpToDate) {\r\n      if (!options.allowShrinkwrapUpdates) {\r\n        console.log();\r\n        console.log(colors.red(\r\n          `The ${this._shrinkwrapFilePhrase} is out of date. You need to run \"rush update\".`\r\n        ));\r\n        throw new AlreadyReportedError();\r\n      }\r\n    }\r\n\r\n    await this._installCommonModules({\r\n      shrinkwrapIsUpToDate,\r\n      variantIsUpToDate,\r\n      ...options\r\n    });\r\n\r\n    if (!options.noLink) {\r\n      const linkManager: BaseLinkManager = LinkManagerFactory.getLinkManager(this._rushConfiguration);\r\n      await linkManager.createSymlinksForProjects(false);\r\n    } else {\r\n      console.log(\r\n        os.EOL + colors.yellow('Since \"--no-link\" was specified, you will need to run \"rush link\" manually.')\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If the \"(p)npm-local\" symlink hasn't been set up yet, this creates it, installing the\r\n   * specified (P)npm version in the user's home directory if needed.\r\n   */\r\n  public ensureLocalPackageManager(): Promise<void> {\r\n    // Example: \"C:\\Users\\YourName\\.rush\"\r\n    const rushUserFolder: string = this._rushGlobalFolder.nodeSpecificPath;\r\n\r\n    if (!FileSystem.exists(rushUserFolder)) {\r\n      console.log('Creating ' + rushUserFolder);\r\n      FileSystem.ensureFolder(rushUserFolder);\r\n    }\r\n\r\n    const packageManager: PackageManagerName = this._rushConfiguration.packageManager;\r\n    const packageManagerVersion: string = this._rushConfiguration.packageManagerToolVersion;\r\n\r\n    const packageManagerAndVersion: string = `${packageManager}-${packageManagerVersion}`;\r\n    // Example: \"C:\\Users\\YourName\\.rush\\pnpm-1.2.3\"\r\n    const packageManagerToolFolder: string = path.join(rushUserFolder, packageManagerAndVersion);\r\n\r\n    const packageManagerMarker: LastInstallFlag = new LastInstallFlag(packageManagerToolFolder, {\r\n      node: process.versions.node\r\n    });\r\n\r\n    console.log(`Trying to acquire lock for ${packageManagerAndVersion}`);\r\n    return LockFile.acquire(rushUserFolder, packageManagerAndVersion).then((lock: LockFile) => {\r\n      console.log(`Acquired lock for ${packageManagerAndVersion}`);\r\n\r\n      if (!packageManagerMarker.isValid() || lock.dirtyWhenAcquired) {\r\n        console.log(colors.bold(`Installing ${packageManager} version ${packageManagerVersion}${os.EOL}`));\r\n\r\n        // note that this will remove the last-install flag from the directory\r\n        Utilities.installPackageInDirectory({\r\n          directory: packageManagerToolFolder,\r\n          packageName: packageManager,\r\n          version: this._rushConfiguration.packageManagerToolVersion,\r\n          tempPackageTitle: `${packageManager}-local-install`,\r\n          maxInstallAttempts: MAX_INSTALL_ATTEMPTS,\r\n          // This is using a local configuration to install a package in a shared global location.\r\n          // Generally that's a bad practice, but in this case if we can successfully install\r\n          // the package at all, we can reasonably assume it's good for all the repositories.\r\n          // In particular, we'll assume that two different NPM registries cannot have two\r\n          // different implementations of the same version of the same package.\r\n          // This was needed for: https://github.com/microsoft/rushstack/issues/691\r\n          commonRushConfigFolder: this._rushConfiguration.commonRushConfigFolder\r\n        });\r\n\r\n        console.log(`Successfully installed ${packageManager} version ${packageManagerVersion}`);\r\n      } else {\r\n        console.log(`Found ${packageManager} version ${packageManagerVersion} in ${packageManagerToolFolder}`);\r\n      }\r\n\r\n      packageManagerMarker.create();\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\"\r\n      FileSystem.ensureFolder(this._rushConfiguration.commonTempFolder);\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\pnpm-local\"\r\n      const localPackageManagerToolFolder: string =\r\n        path.join(this._rushConfiguration.commonTempFolder, `${packageManager}-local`);\r\n\r\n      console.log(os.EOL + 'Symlinking \"' + localPackageManagerToolFolder + '\"');\r\n      console.log('  --> \"' + packageManagerToolFolder + '\"');\r\n\r\n      // We cannot use FileSystem.exists() to test the existence of a symlink, because it will\r\n      // return false for broken symlinks.  There is no way to test without catching an exception.\r\n      try {\r\n        FileSystem.deleteFolder(localPackageManagerToolFolder);\r\n      } catch (error) {\r\n        if (error.code !== 'ENOENT') {\r\n          throw error;\r\n        }\r\n      }\r\n\r\n      FileSystem.createSymbolicLinkJunction({\r\n        linkTargetPath: packageManagerToolFolder,\r\n        newLinkPath: localPackageManagerToolFolder\r\n      });\r\n\r\n      lock.release();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Regenerates the common/package.json and all temp_modules projects.\r\n   * If shrinkwrapFile is provided, this function also validates whether it contains\r\n   * everything we need to install and returns true if so; in all other cases,\r\n   * the return value is false.\r\n   */\r\n  private _createTempModulesAndCheckShrinkwrap(options: {\r\n    shrinkwrapFile: BaseShrinkwrapFile | undefined;\r\n    variant: string | undefined;\r\n  }): boolean {\r\n    const {\r\n      shrinkwrapFile,\r\n      variant\r\n    } = options;\r\n\r\n    const stopwatch: Stopwatch = Stopwatch.start();\r\n\r\n    // Example: \"C:\\MyRepo\\common\\temp\\projects\"\r\n    const tempProjectsFolder: string = path.join(this._rushConfiguration.commonTempFolder,\r\n      RushConstants.rushTempProjectsFolderName);\r\n\r\n    console.log(os.EOL + colors.bold('Updating temp projects in ' + tempProjectsFolder));\r\n\r\n    Utilities.createFolderWithRetry(tempProjectsFolder);\r\n\r\n    const shrinkwrapWarnings: string[] = [];\r\n\r\n    // We will start with the assumption that it's valid, and then set it to false if\r\n    // any of the checks fail\r\n    let shrinkwrapIsUpToDate: boolean = true;\r\n\r\n    if (!shrinkwrapFile) {\r\n      shrinkwrapIsUpToDate = false;\r\n    }\r\n\r\n    // dependency name --> version specifier\r\n    const allExplicitPreferredVersions: Map<string, string> = this._rushConfiguration.getCommonVersions(variant)\r\n      .getAllPreferredVersions();\r\n\r\n    if (shrinkwrapFile) {\r\n      // Check any (explicitly) preferred dependencies first\r\n      allExplicitPreferredVersions.forEach((version: string, dependency: string) => {\r\n        const dependencySpecifier: DependencySpecifier = new DependencySpecifier(dependency, version);\r\n\r\n        if (!shrinkwrapFile.hasCompatibleTopLevelDependency(dependencySpecifier)) {\r\n          shrinkwrapWarnings.push(`\"${dependency}\" (${version}) required by the preferred versions from `\r\n            + RushConstants.commonVersionsFilename);\r\n          shrinkwrapIsUpToDate = false;\r\n        }\r\n      });\r\n\r\n      if (this._findOrphanedTempProjects(shrinkwrapFile)) {\r\n        // If there are any orphaned projects, then \"npm install\" would fail because the shrinkwrap\r\n        // contains references such as \"resolved\": \"file:projects\\\\project1\" that refer to nonexistent\r\n        // file paths.\r\n        shrinkwrapIsUpToDate = false;\r\n      }\r\n    }\r\n\r\n    // Also copy down the committed .npmrc file, if there is one\r\n    // \"common\\config\\rush\\.npmrc\" --> \"common\\temp\\.npmrc\"\r\n    // Also ensure that we remove any old one that may be hanging around\r\n    Utilities.syncNpmrc(this._rushConfiguration.commonRushConfigFolder, this._rushConfiguration.commonTempFolder);\r\n\r\n    // also, copy the pnpmfile.js if it exists\r\n    if (this._rushConfiguration.packageManager === 'pnpm') {\r\n      const committedPnpmFilePath: string =\r\n        this._rushConfiguration.getPnpmfilePath(this._options.variant);\r\n      const tempPnpmFilePath: string\r\n        = path.join(this._rushConfiguration.commonTempFolder, RushConstants.pnpmfileFilename);\r\n\r\n      // ensure that we remove any old one that may be hanging around\r\n      this._syncFile(committedPnpmFilePath, tempPnpmFilePath);\r\n    }\r\n\r\n    const commonPackageJson: IPackageJson = {\r\n      dependencies: {},\r\n      description: 'Temporary file generated by the Rush tool',\r\n      name: 'rush-common',\r\n      private: true,\r\n      version: '0.0.0'\r\n    };\r\n\r\n    // Find the implicitly preferred versions\r\n    // These are any first-level dependencies for which we only consume a single version range\r\n    // (e.g. every package that depends on react uses an identical specifier)\r\n\r\n    // dependency name --> version specifier\r\n    const allPreferredVersions: Map<string, string> =\r\n      InstallManager.collectImplicitlyPreferredVersions(this._rushConfiguration, {\r\n        variant\r\n      });\r\n\r\n    // Add in the explicitly preferred versions.\r\n    // Note that these take precedence over implicitly preferred versions.\r\n    MapExtensions.mergeFromMap(allPreferredVersions, allExplicitPreferredVersions);\r\n\r\n    // Add any preferred versions to the top of the commonPackageJson\r\n    // do this in alphabetical order for simpler debugging\r\n    for (const dependency of Array.from(allPreferredVersions.keys()).sort()) {\r\n      commonPackageJson.dependencies![dependency] = allPreferredVersions.get(dependency)!;\r\n    }\r\n\r\n    // To make the common/package.json file more readable, sort alphabetically\r\n    // according to rushProject.tempProjectName instead of packageName.\r\n    const sortedRushProjects: RushConfigurationProject[] = this._rushConfiguration.projects.slice(0);\r\n    Sort.sortBy(sortedRushProjects, x => x.tempProjectName);\r\n\r\n    for (const rushProject of sortedRushProjects) {\r\n      const packageJson: PackageJsonEditor = rushProject.packageJsonEditor;\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2.tgz\"\r\n      const tarballFile: string = this._getTarballFilePath(rushProject);\r\n\r\n      // Example: \"my-project-2\"\r\n      const unscopedTempProjectName: string = rushProject.unscopedTempProjectName;\r\n\r\n      // Example: dependencies[\"@rush-temp/my-project-2\"] = \"file:./projects/my-project-2.tgz\"\r\n      commonPackageJson.dependencies![rushProject.tempProjectName]\r\n        = `file:./${RushConstants.rushTempProjectsFolderName}/${rushProject.unscopedTempProjectName}.tgz`;\r\n\r\n      const tempPackageJson: IRushTempPackageJson = {\r\n        name: rushProject.tempProjectName,\r\n        version: '0.0.0',\r\n        private: true,\r\n        dependencies: {}\r\n      };\r\n\r\n      // Collect pairs of (packageName, packageVersion) to be added as dependencies of the @rush-temp package.json\r\n      const tempDependencies: Map<string, string> = new Map<string, string>();\r\n\r\n      // These can be regular, optional, or peer dependencies (but NOT dev dependencies).\r\n      // (A given packageName will never appear more than once in this list.)\r\n      for (const dependency of packageJson.dependencyList) {\r\n\r\n        // If there are any optional dependencies, copy directly into the optionalDependencies field.\r\n        if (dependency.dependencyType === DependencyType.Optional) {\r\n          if (!tempPackageJson.optionalDependencies) {\r\n            tempPackageJson.optionalDependencies = {};\r\n          }\r\n          tempPackageJson.optionalDependencies[dependency.name] = dependency.version;\r\n        } else {\r\n          tempDependencies.set(dependency.name, dependency.version);\r\n        }\r\n      }\r\n\r\n      for (const dependency of packageJson.devDependencyList) {\r\n        // If there are devDependencies, we need to merge them with the regular dependencies.  If the same\r\n        // library appears in both places, then the dev dependency wins (because presumably it's saying what you\r\n        // want right now for development, not the range that you support for consumers).\r\n        tempDependencies.set(dependency.name, dependency.version);\r\n      }\r\n      Sort.sortMapKeys(tempDependencies);\r\n\r\n      for (const [packageName, packageVersion] of tempDependencies.entries()) {\r\n        const dependencySpecifier: DependencySpecifier = new DependencySpecifier(packageName, packageVersion);\r\n\r\n        // Is there a locally built Rush project that could satisfy this dependency?\r\n        // If so, then we will symlink to the project folder rather than to common/temp/node_modules.\r\n        // In this case, we don't want \"npm install\" to process this package, but we do need\r\n        // to record this decision for \"rush link\" later, so we add it to a special 'rushDependencies' field.\r\n        const localProject: RushConfigurationProject | undefined =\r\n          this._rushConfiguration.getProjectByName(packageName);\r\n\r\n        if (localProject) {\r\n          // Don't locally link if it's listed in the cyclicDependencyProjects\r\n          if (!rushProject.cyclicDependencyProjects.has(packageName)) {\r\n\r\n            // Also, don't locally link if the SemVer doesn't match\r\n            const localProjectVersion: string = localProject.packageJsonEditor.version;\r\n            if (semver.satisfies(localProjectVersion, packageVersion)) {\r\n\r\n              // We will locally link this package, so instead add it to our special \"rushDependencies\"\r\n              // field in the package.json file.\r\n              if (!tempPackageJson.rushDependencies) {\r\n                tempPackageJson.rushDependencies = {};\r\n              }\r\n              tempPackageJson.rushDependencies[packageName] = packageVersion;\r\n              continue;\r\n            }\r\n          }\r\n        }\r\n\r\n        // We will NOT locally link this package; add it as a regular dependency.\r\n        tempPackageJson.dependencies![packageName] = packageVersion;\r\n\r\n        if (shrinkwrapFile) {\r\n          if (!shrinkwrapFile.tryEnsureCompatibleDependency(dependencySpecifier, rushProject.tempProjectName)) {\r\n            shrinkwrapWarnings.push(`\"${packageName}\" (${packageVersion}) required by`\r\n              + ` \"${rushProject.packageName}\"`);\r\n            shrinkwrapIsUpToDate = false;\r\n          }\r\n        }\r\n      }\r\n\r\n      // NPM expects the root of the tarball to have a directory called 'package'\r\n      const npmPackageFolder: string = 'package';\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2\"\r\n      const tempProjectFolder: string = path.join(\r\n        this._rushConfiguration.commonTempFolder,\r\n        RushConstants.rushTempProjectsFolderName,\r\n        unscopedTempProjectName);\r\n\r\n      // Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2\\package.json\"\r\n      const tempPackageJsonFilename: string = path.join(tempProjectFolder, FileConstants.PackageJson);\r\n\r\n      // we only want to overwrite the package if the existing tarball's package.json is different from tempPackageJson\r\n      let shouldOverwrite: boolean = true;\r\n      try {\r\n        // if the tarball and the temp file still exist, then compare the contents\r\n        if (FileSystem.exists(tarballFile) && FileSystem.exists(tempPackageJsonFilename)) {\r\n\r\n          // compare the extracted package.json with the one we are about to write\r\n          const oldBuffer: Buffer = FileSystem.readFileToBuffer(tempPackageJsonFilename);\r\n          const newBuffer: Buffer = Buffer.from(JsonFile.stringify(tempPackageJson));\r\n\r\n          if (Buffer.compare(oldBuffer, newBuffer) === 0) {\r\n            shouldOverwrite = false;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        // ignore the error, we will go ahead and create a new tarball\r\n      }\r\n\r\n      if (shouldOverwrite) {\r\n        try {\r\n          // ensure the folder we are about to zip exists\r\n          Utilities.createFolderWithRetry(tempProjectFolder);\r\n\r\n          // remove the old tarball & old temp package json, this is for any cases where new tarball creation\r\n          // fails, and the shouldOverwrite logic is messed up because the my-project-2\\package.json\r\n          // exists and is updated, but the tarball is not accurate\r\n          FileSystem.deleteFile(tarballFile);\r\n          FileSystem.deleteFile(tempPackageJsonFilename);\r\n\r\n          // write the expected package.json file into the zip staging folder\r\n          JsonFile.save(tempPackageJson, tempPackageJsonFilename);\r\n\r\n          // create the new tarball\r\n          tar.create({\r\n            gzip: true,\r\n            file: tarballFile,\r\n            cwd: tempProjectFolder,\r\n            portable: true,\r\n            noMtime: true,\r\n            noPax: true,\r\n            sync: true,\r\n            prefix: npmPackageFolder\r\n          } as CreateOptions, [FileConstants.PackageJson]);\r\n\r\n          console.log(`Updating ${tarballFile}`);\r\n        } catch (error) {\r\n          // delete everything in case of any error\r\n          FileSystem.deleteFile(tarballFile);\r\n          FileSystem.deleteFile(tempPackageJsonFilename);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Example: \"C:\\MyRepo\\common\\temp\\package.json\"\r\n    const commonPackageJsonFilename: string = path.join(this._rushConfiguration.commonTempFolder,\r\n      FileConstants.PackageJson);\r\n\r\n    if (shrinkwrapFile) {\r\n      // If we have a (possibly incomplete) shrinkwrap file, save it as the temporary file.\r\n      shrinkwrapFile.save(this._rushConfiguration.tempShrinkwrapFilename);\r\n      shrinkwrapFile.save(this._rushConfiguration.tempShrinkwrapPreinstallFilename);\r\n    } else {\r\n      // Otherwise delete the temporary file\r\n      FileSystem.deleteFile(this._rushConfiguration.tempShrinkwrapFilename);\r\n\r\n      if (this._rushConfiguration.packageManager === 'pnpm') {\r\n        const commonNodeModulesFolder: string = path.join(this._rushConfiguration.commonTempFolder, 'node_modules');\r\n\r\n        // Workaround for https://github.com/pnpm/pnpm/issues/1890\r\n        //\r\n        // When \"rush update --full\" is run, rush deletes common/temp/pnpm-lock.yaml so that\r\n        // a new lockfile can be generated. But because of the above bug \"pnpm install\" would\r\n        // respect \"common/temp/node_modules/.pnpm-lock.yaml\" and thus would not generate a\r\n        // new lockfile. Deleting this file in addition to deleting common/temp/pnpm-lock.yaml\r\n        // ensures that a new lockfile will be generated with \"rush update --full\".\r\n\r\n        // Note that there is period in the file name: common/temp/node_modules/.pnpm-lock.yaml\r\n        const pnpmShrinkwrapInNodeModulesFolder: string = path.join(commonNodeModulesFolder, '.'\r\n          + this._rushConfiguration.shrinkwrapFilename);\r\n        FileSystem.deleteFile(pnpmShrinkwrapInNodeModulesFolder);\r\n      }\r\n    }\r\n\r\n    // Don't update the file timestamp unless the content has changed, since \"rush install\"\r\n    // will consider this timestamp\r\n    JsonFile.save(commonPackageJson, commonPackageJsonFilename, { onlyIfChanged: true });\r\n\r\n    stopwatch.stop();\r\n    console.log(`Finished creating temporary modules (${stopwatch.toString()})`);\r\n\r\n    if (shrinkwrapWarnings.length > 0) {\r\n      console.log();\r\n      console.log(colors.yellow(Utilities.wrapWords(\r\n        `The ${this._shrinkwrapFilePhrase} is missing the following dependencies:`)));\r\n\r\n      for (const shrinkwrapWarning of shrinkwrapWarnings) {\r\n        console.log(colors.yellow('  ' + shrinkwrapWarning));\r\n      }\r\n      console.log();\r\n    }\r\n\r\n    return shrinkwrapIsUpToDate;\r\n  }\r\n\r\n  /**\r\n   * Runs \"npm install\" in the common folder.\r\n   */\r\n  private _installCommonModules(options: {\r\n    shrinkwrapIsUpToDate: boolean;\r\n    variantIsUpToDate: boolean;\r\n  } & IInstallManagerOptions): Promise<void> {\r\n    const {\r\n      shrinkwrapIsUpToDate,\r\n      variantIsUpToDate\r\n    } = options;\r\n\r\n    return Promise.resolve().then(() => {\r\n      console.log(os.EOL + colors.bold('Checking node_modules in ' + this._rushConfiguration.commonTempFolder)\r\n        + os.EOL);\r\n\r\n      const commonNodeModulesFolder: string = path.join(this._rushConfiguration.commonTempFolder,\r\n        'node_modules');\r\n\r\n      // This marker file indicates that the last \"rush install\" completed successfully\r\n      const markerFileExistedAndWasValidAtStart: boolean = this._commonNodeModulesMarker.isValid();\r\n\r\n      // If \"--clean\" or \"--full-clean\" was specified, or if the last install was interrupted,\r\n      // then we will need to delete the node_modules folder.  Otherwise, we can do an incremental\r\n      // install.\r\n      const deleteNodeModules: boolean = !markerFileExistedAndWasValidAtStart;\r\n\r\n      // Based on timestamps, can we skip this install entirely?\r\n      if (shrinkwrapIsUpToDate && !deleteNodeModules && variantIsUpToDate) {\r\n        const potentiallyChangedFiles: string[] = [];\r\n\r\n        // Consider the timestamp on the node_modules folder; if someone tampered with it\r\n        // or deleted it entirely, then we can't skip this install\r\n        potentiallyChangedFiles.push(commonNodeModulesFolder);\r\n\r\n        // Additionally, if they pulled an updated npm-shrinkwrap.json file from Git,\r\n        // then we can't skip this install\r\n        potentiallyChangedFiles.push(this._rushConfiguration.getCommittedShrinkwrapFilename(options.variant));\r\n\r\n        if (this._rushConfiguration.packageManager === 'pnpm') {\r\n          // If the repo is using pnpmfile.js, consider that also\r\n          const pnpmFileFilename: string = this._rushConfiguration.getPnpmfilePath(options.variant);\r\n\r\n          if (FileSystem.exists(pnpmFileFilename)) {\r\n            potentiallyChangedFiles.push(pnpmFileFilename);\r\n          }\r\n        }\r\n\r\n        // Also consider timestamps for all the temp tarballs. (createTempModulesAndCheckShrinkwrap() will\r\n        // carefully preserve these timestamps unless something has changed.)\r\n        // Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2.tgz\"\r\n        potentiallyChangedFiles.push(...this._rushConfiguration.projects.map(x => {\r\n          return this._getTarballFilePath(x);\r\n        }));\r\n\r\n        // NOTE: If commonNodeModulesMarkerFilename (or any of the potentiallyChangedFiles) does not\r\n        // exist, then isFileTimestampCurrent() returns false.\r\n        if (Utilities.isFileTimestampCurrent(this._commonNodeModulesMarker.path, potentiallyChangedFiles)) {\r\n          // Nothing to do, because everything is up to date according to time stamps\r\n          return;\r\n        }\r\n      }\r\n\r\n      return this._checkIfReleaseIsPublished()\r\n        .catch((error) => {\r\n          // If the user is working in an environment that can't reach the registry,\r\n          // don't bother them with errors.\r\n          return undefined;\r\n        }).then((publishedRelease: boolean | undefined) => {\r\n\r\n          if (publishedRelease === false) {\r\n            console.log(colors.yellow('Warning: This release of the Rush tool was unpublished; it may be unstable.'));\r\n          }\r\n\r\n          // Since we're going to be tampering with common/node_modules, delete the \"rush link\" flag file if it exists;\r\n          // this ensures that a full \"rush link\" is required next time\r\n          Utilities.deleteFile(this._rushConfiguration.rushLinkJsonFilename);\r\n\r\n          // Delete the successful install file to indicate the install transaction has started\r\n          this._commonNodeModulesMarker.clear();\r\n\r\n          // NOTE: The PNPM store is supposed to be transactionally safe, so we don't delete it automatically.\r\n          // The user must request that via the command line.\r\n          if (deleteNodeModules) {\r\n            if (this._rushConfiguration.packageManager === 'npm') {\r\n              console.log(`Deleting the \"npm-cache\" folder`);\r\n              // This is faster and more thorough than \"npm cache clean\"\r\n              this._commonTempFolderRecycler.moveFolder(this._rushConfiguration.npmCacheFolder);\r\n\r\n              console.log(`Deleting the \"npm-tmp\" folder`);\r\n              this._commonTempFolderRecycler.moveFolder(this._rushConfiguration.npmTmpFolder);\r\n            }\r\n          }\r\n\r\n          // Example: \"C:\\MyRepo\\common\\temp\\npm-local\\node_modules\\.bin\\npm\"\r\n          const packageManagerFilename: string = this._rushConfiguration.packageManagerToolFilename;\r\n\r\n          // Is there an existing \"node_modules\" folder to consider?\r\n          if (FileSystem.exists(commonNodeModulesFolder)) {\r\n            // Should we delete the entire \"node_modules\" folder?\r\n            if (deleteNodeModules) {\r\n              // YES: Delete \"node_modules\"\r\n\r\n              // Explain to the user why we are hosing their node_modules folder\r\n              console.log('Deleting files from ' + commonNodeModulesFolder);\r\n\r\n              this._commonTempFolderRecycler.moveFolder(commonNodeModulesFolder);\r\n\r\n              Utilities.createFolderWithRetry(commonNodeModulesFolder);\r\n            } else {\r\n              // NO: Prepare to do an incremental install in the \"node_modules\" folder\r\n\r\n              // note: it is not necessary to run \"prune\" with pnpm\r\n              if (this._rushConfiguration.packageManager === 'npm') {\r\n                console.log(`Running \"${this._rushConfiguration.packageManager} prune\"`\r\n                  + ` in ${this._rushConfiguration.commonTempFolder}`);\r\n                const args: string[] = ['prune'];\r\n                this._pushConfigurationArgs(args, options);\r\n\r\n                Utilities.executeCommandWithRetry(MAX_INSTALL_ATTEMPTS, packageManagerFilename, args,\r\n                  this._rushConfiguration.commonTempFolder);\r\n\r\n                // Delete the (installed image of) the temp projects, since \"npm install\" does not\r\n                // detect changes for \"file:./\" references.\r\n                // We recognize the temp projects by their names, which always start with \"rush-\".\r\n\r\n                // Example: \"C:\\MyRepo\\common\\temp\\node_modules\\@rush-temp\"\r\n                const pathToDeleteWithoutStar: string = path.join(commonNodeModulesFolder,\r\n                  RushConstants.rushTempNpmScope);\r\n                console.log(`Deleting ${pathToDeleteWithoutStar}\\\\*`);\r\n                // Glob can't handle Windows paths\r\n                const normalizedpathToDeleteWithoutStar: string = Text.replaceAll(pathToDeleteWithoutStar, '\\\\', '/');\r\n\r\n                // Example: \"C:/MyRepo/common/temp/node_modules/@rush-temp/*\"\r\n                for (const tempModulePath of glob.sync(globEscape(normalizedpathToDeleteWithoutStar) + '/*')) {\r\n                  // We could potentially use AsyncRecycler here, but in practice these folders tend\r\n                  // to be very small\r\n                  Utilities.dangerouslyDeletePath(tempModulePath);\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          if (this._rushConfiguration.packageManager === 'yarn') {\r\n            // Yarn does not correctly detect changes to a tarball, so we need to forcibly clear its cache\r\n            const yarnRushTempCacheFolder: string = path.join(\r\n              this._rushConfiguration.yarnCacheFolder, 'v2', 'npm-@rush-temp'\r\n            );\r\n            if (FileSystem.exists(yarnRushTempCacheFolder)) {\r\n              console.log('Deleting ' + yarnRushTempCacheFolder);\r\n              Utilities.dangerouslyDeletePath(yarnRushTempCacheFolder);\r\n            }\r\n          }\r\n\r\n          // Run \"npm install\" in the common folder\r\n          const installArgs: string[] = ['install'];\r\n          this._pushConfigurationArgs(installArgs, options);\r\n\r\n          console.log(os.EOL + colors.bold(`Running \"${this._rushConfiguration.packageManager} install\" in`\r\n            + ` ${this._rushConfiguration.commonTempFolder}`) + os.EOL);\r\n\r\n          // If any diagnostic options were specified, then show the full command-line\r\n          if (options.debug || options.collectLogFile || options.networkConcurrency) {\r\n            console.log(os.EOL + colors.green('Invoking package manager: ')\r\n              + FileSystem.getRealPath(packageManagerFilename) + ' ' + installArgs.join(' ') + os.EOL);\r\n          }\r\n\r\n          try {\r\n            Utilities.executeCommandWithRetry(MAX_INSTALL_ATTEMPTS, packageManagerFilename,\r\n              installArgs,\r\n              this._rushConfiguration.commonTempFolder,\r\n              undefined,\r\n              false, () => {\r\n                if (this._rushConfiguration.packageManager === 'pnpm') {\r\n                  console.log(colors.yellow(`Deleting the \"node_modules\" folder`));\r\n                  this._commonTempFolderRecycler.moveFolder(commonNodeModulesFolder);\r\n\r\n                  // Leave the pnpm-store as is for the retry. This ensures that packages that have already\r\n                  // been downloaded need not be downloaded again, thereby potentially increasing the chances\r\n                  // of a subsequent successful install.\r\n\r\n                  Utilities.createFolderWithRetry(commonNodeModulesFolder);\r\n                }\r\n            });\r\n          } catch (error) {\r\n            // All the install attempts failed.\r\n\r\n            if (this._rushConfiguration.packageManager === 'pnpm') {\r\n              // If the installation has failed even after the retries, then pnpm store may\r\n              // have got into a corrupted, irrecoverable state. Delete the store so that a\r\n              // future install can create the store afresh.\r\n              console.log(colors.yellow(`Deleting the \"pnpm-store\" folder`));\r\n              this._commonTempFolderRecycler.moveFolder(this._rushConfiguration.pnpmStoreFolder);\r\n            }\r\n\r\n            throw error;\r\n          }\r\n\r\n          if (this._rushConfiguration.packageManager === 'npm') {\r\n\r\n            console.log(os.EOL + colors.bold('Running \"npm shrinkwrap\"...'));\r\n            const npmArgs: string[] = ['shrinkwrap'];\r\n            this._pushConfigurationArgs(npmArgs, options);\r\n            Utilities.executeCommand(this._rushConfiguration.packageManagerToolFilename,\r\n              npmArgs, this._rushConfiguration.commonTempFolder);\r\n            console.log('\"npm shrinkwrap\" completed' + os.EOL);\r\n\r\n            this._fixupNpm5Regression();\r\n          }\r\n\r\n          if (options.allowShrinkwrapUpdates && !shrinkwrapIsUpToDate) {\r\n            // Copy (or delete) common\\temp\\pnpm-lock.yaml --> common\\config\\rush\\pnpm-lock.yaml\r\n            this._syncFile(this._rushConfiguration.tempShrinkwrapFilename,\r\n              this._rushConfiguration.getCommittedShrinkwrapFilename(options.variant));\r\n          } else {\r\n            // TODO: Validate whether the package manager updated it in a nontrivial way\r\n          }\r\n\r\n          // Finally, create the marker file to indicate a successful install\r\n          this._commonNodeModulesMarker.create();\r\n\r\n          console.log('');\r\n        });\r\n    });\r\n  }\r\n\r\n  private _checkIfReleaseIsPublished(): Promise<boolean> {\r\n    return Promise.resolve().then(() => {\r\n      const lastCheckFile: string = path.join(this._rushGlobalFolder.nodeSpecificPath,\r\n        'rush-' + Rush.version, 'last-check.flag');\r\n\r\n      if (FileSystem.exists(lastCheckFile)) {\r\n        let cachedResult: boolean | 'error' | undefined = undefined;\r\n        try {\r\n          // NOTE: mtimeMs is not supported yet in Node.js 6.x\r\n          const nowMs: number = new Date().getTime();\r\n          const ageMs: number = nowMs - FileSystem.getStatistics(lastCheckFile).mtime.getTime();\r\n          const HOUR: number = 60 * 60 * 1000;\r\n\r\n          // Is the cache too old?\r\n          if (ageMs < 24 * HOUR) {\r\n            // No, read the cached result\r\n            cachedResult = JsonFile.load(lastCheckFile);\r\n          }\r\n        } catch (e) {\r\n          // Unable to parse file\r\n        }\r\n        if (cachedResult === 'error') {\r\n          return Promise.reject(new Error('Unable to contact server'));\r\n        }\r\n        if (cachedResult === true || cachedResult === false) {\r\n          return cachedResult;\r\n        }\r\n      }\r\n\r\n      // Before we start the network operation, record a failed state.  If the process exits for some reason,\r\n      // this will record the error.  It will also update the timestamp to prevent other Rush instances\r\n      // from attempting to update the file.\r\n      JsonFile.save('error', lastCheckFile, { ensureFolderExists: true });\r\n\r\n      // For this check we use the official registry, not the private registry\r\n      return this._queryIfReleaseIsPublished('https://registry.npmjs.org:443')\r\n        .then((publishedRelease: boolean) => {\r\n          // Cache the result\r\n          JsonFile.save(publishedRelease, lastCheckFile, { ensureFolderExists: true });\r\n          return publishedRelease;\r\n        })\r\n        .catch((error: Error) => {\r\n          JsonFile.save('error', lastCheckFile, { ensureFolderExists: true });\r\n          return Promise.reject(error);\r\n        });\r\n    });\r\n  }\r\n\r\n  private _queryIfReleaseIsPublished(registryUrl: string): Promise<boolean> {\r\n    let queryUrl: string = registryUrl;\r\n    if (queryUrl[-1] !== '/') {\r\n      queryUrl += '/';\r\n    }\r\n    // Note that the \"@\" symbol does not normally get URL-encoded\r\n    queryUrl += RushConstants.rushPackageName.replace('/', '%2F');\r\n\r\n    const userAgent: string = `pnpm/? npm/? node/${process.version} ${os.platform()} ${os.arch()}`;\r\n\r\n    const headers: fetch.Headers = new fetch.Headers();\r\n    headers.append('user-agent', userAgent);\r\n    headers.append('accept', 'application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*');\r\n\r\n    let agent: http.Agent | undefined = undefined;\r\n    if (process.env.HTTP_PROXY) {\r\n      agent = new HttpsProxyAgent(process.env.HTTP_PROXY);\r\n    }\r\n\r\n    return fetch.default(queryUrl, {\r\n      headers: headers,\r\n      agent: agent\r\n    })\r\n      .then((response: fetch.Response) => {\r\n        if (!response.ok) {\r\n          return Promise.reject(new Error('Failed to query'));\r\n        }\r\n        return response\r\n          .json()\r\n          .then((data) => {\r\n            let url: string;\r\n            try {\r\n              if (!data.versions[Rush.version]) {\r\n                // Version was not published\r\n                return false;\r\n              }\r\n              url = data.versions[Rush.version].dist.tarball;\r\n              if (!url) {\r\n                return Promise.reject(new Error(`URL not found`));\r\n              }\r\n            } catch (e) {\r\n              return Promise.reject(new Error('Error parsing response'));\r\n            }\r\n\r\n            // Make sure the tarball wasn't deleted from the CDN\r\n            headers.set('accept', '*/*');\r\n            return fetch.default(url, {\r\n              headers: headers,\r\n              agent: agent\r\n            })\r\n              .then<boolean>((response2: fetch.Response) => {\r\n                if (!response2.ok) {\r\n                  if (response2.status === 404) {\r\n                    return false;\r\n                  } else {\r\n                    return Promise.reject(new Error('Failed to fetch'));\r\n                  }\r\n                }\r\n                return true;\r\n              });\r\n          });\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Used when invoking the NPM tool.  Appends the common configuration options\r\n   * to the command-line.\r\n   */\r\n  private _pushConfigurationArgs(args: string[], options: IInstallManagerOptions): void {\r\n    if (this._rushConfiguration.packageManager === 'npm') {\r\n      if (semver.lt(this._rushConfiguration.packageManagerToolVersion, '5.0.0')) {\r\n        // NOTE:\r\n        //\r\n        // When using an npm version older than v5.0.0, we do NOT install optional dependencies for\r\n        // Rush, because npm does not generate the shrinkwrap file consistently across platforms.\r\n        //\r\n        // Consider the \"fsevents\" package. This is a Mac specific package\r\n        // which is an optional second-order dependency. Optional dependencies work by attempting to install\r\n        // the package, but removes the package if the install failed.\r\n        // This means that someone running generate on a Mac WILL have fsevents included in their shrinkwrap.\r\n        // When someone using Windows attempts to install from the shrinkwrap, the install will fail.\r\n        //\r\n        // If someone generates the shrinkwrap using Windows, then fsevents will NOT be listed in the shrinkwrap.\r\n        // When someone using Mac attempts to install from the shrinkwrap, they will NOT have the\r\n        // optional dependency installed.\r\n        //\r\n        // This issue has been fixed as of npm v5.0.0: https://github.com/npm/npm/releases/tag/v5.0.0\r\n        //\r\n        // For more context, see https://github.com/microsoft/rushstack/issues/761#issuecomment-428689600\r\n        args.push('--no-optional');\r\n      }\r\n      args.push('--cache', this._rushConfiguration.npmCacheFolder);\r\n      args.push('--tmp', this._rushConfiguration.npmTmpFolder);\r\n\r\n      if (options.collectLogFile) {\r\n        args.push('--verbose');\r\n      }\r\n    } else if (this._rushConfiguration.packageManager === 'pnpm') {\r\n      args.push('--store', this._rushConfiguration.pnpmStoreFolder);\r\n\r\n      // we are using the --no-lock flag for now, which unfortunately prints a warning, but should be OK\r\n      // since rush already has its own install lock file which will invalidate the cache for us.\r\n      // we theoretically could use the lock file, but we would need to clean the store if the\r\n      // lockfile existed, otherwise PNPM would hang indefinitely. it is simpler to rely on Rush's\r\n      // last install flag, which encapsulates the entire installation\r\n      args.push('--no-lock');\r\n\r\n      // Ensure that Rush's tarball dependencies get synchronized properly with the pnpm-lock.yaml file.\r\n      // See this GitHub issue: https://github.com/pnpm/pnpm/issues/1342\r\n      if (semver.gte(this._rushConfiguration.packageManagerToolVersion, '3.0.0')) {\r\n        args.push('--no-prefer-frozen-lockfile');\r\n      } else {\r\n        args.push('--no-prefer-frozen-shrinkwrap');\r\n      }\r\n\r\n      if (options.collectLogFile) {\r\n        args.push('--reporter', 'ndjson');\r\n      }\r\n\r\n      if (options.networkConcurrency) {\r\n        args.push('--network-concurrency', options.networkConcurrency.toString());\r\n      }\r\n\r\n      if (this._rushConfiguration.pnpmOptions.strictPeerDependencies) {\r\n        args.push('--strict-peer-dependencies');\r\n      }\r\n\r\n      if ((this._rushConfiguration.packageManagerWrapper as PnpmPackageManager).supportsResolutionStrategy) {\r\n        args.push('--resolution-strategy', this._rushConfiguration.pnpmOptions.resolutionStrategy);\r\n      }\r\n    } else if (this._rushConfiguration.packageManager === 'yarn') {\r\n      args.push('--link-folder', 'yarn-link');\r\n      args.push('--cache-folder', this._rushConfiguration.yarnCacheFolder);\r\n\r\n      // Without this option, Yarn will sometimes stop and ask for user input on STDIN\r\n      // (e.g. \"Which command would you like to run?\").\r\n      args.push('--non-interactive');\r\n\r\n      if (options.networkConcurrency) {\r\n        args.push('--network-concurrency', options.networkConcurrency.toString());\r\n      }\r\n\r\n      if (this._rushConfiguration.yarnOptions.ignoreEngines) {\r\n        args.push('--ignore-engines');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Copies the file \"sourcePath\" to \"destinationPath\", overwriting the target file location.\r\n   * If the source file does not exist, then the target file is deleted.\r\n   */\r\n  private _syncFile(sourcePath: string, destinationPath: string): void {\r\n    if (FileSystem.exists(sourcePath)) {\r\n      console.log('Updating ' + destinationPath);\r\n      FileSystem.copyFile({ sourcePath, destinationPath });\r\n    } else {\r\n      if (FileSystem.exists(destinationPath)) {\r\n        console.log('Deleting ' + destinationPath);\r\n        FileSystem.deleteFile(destinationPath);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the path to the tarball\r\n   * Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2.tgz\"\r\n   */\r\n  private _getTarballFilePath(project: RushConfigurationProject): string {\r\n    return path.join(\r\n      this._rushConfiguration.commonTempFolder,\r\n      RushConstants.rushTempProjectsFolderName,\r\n      `${project.unscopedTempProjectName}.tgz`);\r\n  }\r\n\r\n  /**\r\n   * This is a workaround for a bug introduced in NPM 5 (and still unfixed as of NPM 5.5.1):\r\n   * https://github.com/npm/npm/issues/19006\r\n   *\r\n   * The regression is that \"npm install\" sets the package.json \"version\" field for the\r\n   * @rush-temp projects to a value like \"file:projects/example.tgz\", when it should be \"0.0.0\".\r\n   * This causes \"rush link\" to fail later, when read-package-tree tries to parse the bad version.\r\n   * The error looks like this:\r\n   *\r\n   * ERROR: Failed to parse package.json for foo: Invalid version: \"file:projects/example.tgz\"\r\n   *\r\n   * Our workaround is to rewrite the package.json files for each of the @rush-temp projects\r\n   * in the node_modules folder, after \"npm install\" completes.\r\n   */\r\n  private _fixupNpm5Regression(): void {\r\n    const pathToDeleteWithoutStar: string = path.join(this._rushConfiguration.commonTempFolder,\r\n      'node_modules', RushConstants.rushTempNpmScope);\r\n    // Glob can't handle Windows paths\r\n    const normalizedpathToDeleteWithoutStar: string = Text.replaceAll(pathToDeleteWithoutStar, '\\\\', '/');\r\n\r\n    let anyChanges: boolean = false;\r\n\r\n    // Example: \"C:/MyRepo/common/temp/node_modules/@rush-temp/*/package.json\"\r\n    for (const packageJsonPath of glob.sync(globEscape(normalizedpathToDeleteWithoutStar) + '/*/package.json')) {\r\n      // Example: \"C:/MyRepo/common/temp/node_modules/@rush-temp/example/package.json\"\r\n      const packageJsonObject: IRushTempPackageJson = JsonFile.load(packageJsonPath);\r\n\r\n      // The temp projects always use \"0.0.0\" as their version\r\n      packageJsonObject.version = '0.0.0';\r\n\r\n      if (JsonFile.save(packageJsonObject, packageJsonPath, { onlyIfChanged: true })) {\r\n        anyChanges = true;\r\n      }\r\n    }\r\n\r\n    if (anyChanges) {\r\n      console.log(os.EOL + colors.yellow(Utilities.wrapWords(`Applied workaround for NPM 5 bug`)) + os.EOL);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks for temp projects that exist in the shrinkwrap file, but don't exist\r\n   * in rush.json.  This might occur, e.g. if a project was recently deleted or renamed.\r\n   *\r\n   * @returns true if orphans were found, or false if everything is okay\r\n   */\r\n  private _findOrphanedTempProjects(shrinkwrapFile: BaseShrinkwrapFile): boolean {\r\n\r\n    // We can recognize temp projects because they are under the \"@rush-temp\" NPM scope.\r\n    for (const tempProjectName of shrinkwrapFile.getTempProjectNames()) {\r\n      if (!this._rushConfiguration.findProjectByTempName(tempProjectName)) {\r\n        console.log(os.EOL + colors.yellow(Utilities.wrapWords(\r\n          `Your ${this._shrinkwrapFilePhrase} references a project \"${tempProjectName}\" which no longer exists.`))\r\n          + os.EOL);\r\n        return true;  // found one\r\n      }\r\n    }\r\n\r\n    return false;  // none found\r\n  }\r\n\r\n  private get _shrinkwrapFilePhrase(): string {\r\n    return this._rushConfiguration.shrinkwrapFilePhrase;\r\n  }\r\n}\r\n"]}