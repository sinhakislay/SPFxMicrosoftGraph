{"version":3,"file":"BulkScriptAction.js","sourceRoot":"","sources":["../../../src/cli/scriptActions/BulkScriptAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as os from 'os';\r\nimport * as colors from 'colors';\r\n\r\nimport {\r\n  Event\r\n} from '../../index';\r\n\r\nimport {\r\n  CommandLineFlagParameter,\r\n  CommandLineStringParameter,\r\n  CommandLineStringListParameter,\r\n  CommandLineParameterKind\r\n} from '@microsoft/ts-command-line';\r\n\r\nimport { SetupChecks } from '../../logic/SetupChecks';\r\nimport { TaskSelector } from '../../logic/TaskSelector';\r\nimport { Stopwatch } from '../../utilities/Stopwatch';\r\nimport { AlreadyReportedError } from '../../utilities/AlreadyReportedError';\r\nimport { BaseScriptAction, IBaseScriptActionOptions } from './BaseScriptAction';\r\nimport { FileSystem } from '@microsoft/node-core-library';\r\nimport { TaskRunner } from '../../logic/taskRunner/TaskRunner';\r\nimport { TaskCollection } from '../../logic/taskRunner/TaskCollection';\r\nimport { Utilities } from '../../utilities/Utilities';\r\n\r\n/**\r\n * Constructor parameters for BulkScriptAction.\r\n */\r\nexport interface IBulkScriptActionOptions extends IBaseScriptActionOptions {\r\n  enableParallelism: boolean;\r\n  ignoreMissingScript: boolean;\r\n  ignoreDependencyOrder: boolean;\r\n  incremental: boolean;\r\n  allowWarningsInSuccessfulBuild: boolean;\r\n\r\n  /**\r\n   * Optional command to run. Otherwise, use the `actionName` as the command to run.\r\n   */\r\n  commandToRun?: string;\r\n}\r\n\r\n/**\r\n * This class implements bulk commands which are run individually for each project in the repo,\r\n * possibly in parallel.  The action executes a script found in the project's package.json file.\r\n *\r\n * @remarks\r\n * Bulk commands can be defined via common/config/command-line.json.  Rush's predefined \"build\"\r\n * and \"rebuild\" commands are also modeled as bulk commands, because they essentially just\r\n * execute scripts from package.json in the same as any custom command.\r\n */\r\nexport class BulkScriptAction extends BaseScriptAction {\r\n  private _enableParallelism: boolean;\r\n  private _ignoreMissingScript: boolean;\r\n  private _isIncrementalBuildAllowed: boolean;\r\n  private _commandToRun: string;\r\n\r\n  private _changedProjectsOnly: CommandLineFlagParameter;\r\n  private _fromFlag: CommandLineStringListParameter;\r\n  private _toFlag: CommandLineStringListParameter;\r\n  private _fromVersionPolicy: CommandLineStringListParameter;\r\n  private _toVersionPolicy: CommandLineStringListParameter;\r\n  private _verboseParameter: CommandLineFlagParameter;\r\n  private _parallelismParameter: CommandLineStringParameter | undefined;\r\n  private _ignoreDependencyOrder: boolean;\r\n  private _allowWarningsInSuccessfulBuild: boolean;\r\n\r\n  constructor(options: IBulkScriptActionOptions) {\r\n    super(options);\r\n    this._enableParallelism = options.enableParallelism;\r\n    this._ignoreMissingScript = options.ignoreMissingScript;\r\n    this._isIncrementalBuildAllowed = options.incremental;\r\n    this._commandToRun = options.commandToRun || options.actionName;\r\n    this._ignoreDependencyOrder = options.ignoreDependencyOrder;\r\n    this._allowWarningsInSuccessfulBuild = options.allowWarningsInSuccessfulBuild;\r\n  }\r\n\r\n  public run(): Promise<void> {\r\n    if (!FileSystem.exists(this.rushConfiguration.rushLinkJsonFilename)) {\r\n      throw new Error(`File not found: ${this.rushConfiguration.rushLinkJsonFilename}` +\r\n        `${os.EOL}Did you run \"rush link\"?`);\r\n    }\r\n    this._doBeforeTask();\r\n\r\n    const stopwatch: Stopwatch = Stopwatch.start();\r\n\r\n    const isQuietMode: boolean = !(this._verboseParameter.value);\r\n\r\n    // if this is parallelizable, then use the value from the flag (undefined or a number),\r\n    // if parallelism is not enabled, then restrict to 1 core\r\n    const parallelism: string | undefined = this._enableParallelism\r\n      ? this._parallelismParameter!.value\r\n      : '1';\r\n\r\n    // Collect all custom parameter values\r\n    const customParameterValues: string[] = [];\r\n    for (const customParameter of this.customParameters) {\r\n      customParameter.appendToArgList(customParameterValues);\r\n    }\r\n\r\n    const changedProjectsOnly: boolean = this._isIncrementalBuildAllowed && this._changedProjectsOnly.value;\r\n\r\n    const taskSelector: TaskSelector = new TaskSelector({\r\n      rushConfiguration: this.rushConfiguration,\r\n      toFlags: this._mergeProjectsWithVersionPolicy(this._toFlag, this._toVersionPolicy),\r\n      fromFlags: this._mergeProjectsWithVersionPolicy(this._fromFlag, this._fromVersionPolicy),\r\n      commandToRun: this._commandToRun,\r\n      customParameterValues,\r\n      isQuietMode: isQuietMode,\r\n      isIncrementalBuildAllowed: this._isIncrementalBuildAllowed,\r\n      ignoreMissingScript: this._ignoreMissingScript,\r\n      ignoreDependencyOrder: this._ignoreDependencyOrder,\r\n      packageDepsFilename: Utilities.getPackageDepsFilenameForCommand(this._commandToRun)\r\n    });\r\n\r\n    // Register all tasks with the task collection\r\n    const taskCollection: TaskCollection = taskSelector.registerTasks();\r\n\r\n    const taskRunner: TaskRunner = new TaskRunner(\r\n      taskCollection.getOrderedTasks(),\r\n      {\r\n        quietMode: isQuietMode,\r\n        parallelism: parallelism,\r\n        changedProjectsOnly: changedProjectsOnly,\r\n        allowWarningsInSuccessfulBuild: this._allowWarningsInSuccessfulBuild\r\n      }\r\n    );\r\n\r\n    return taskRunner.execute().then(() => {\r\n      stopwatch.stop();\r\n      console.log(colors.green(`rush ${this.actionName} (${stopwatch.toString()})`));\r\n      this._doAfterTask(stopwatch, true);\r\n    }).catch((error: Error) => {\r\n      stopwatch.stop();\r\n      if (error instanceof AlreadyReportedError) {\r\n        console.log(colors.green(`rush ${this.actionName} (${stopwatch.toString()})`));\r\n      } else {\r\n        if (error && error.message) {\r\n          console.log('Error: ' + error.message);\r\n        }\r\n\r\n        console.log(colors.red(`rush ${this.actionName} - Errors! (${stopwatch.toString()})`));\r\n      }\r\n\r\n      this._doAfterTask(stopwatch, false);\r\n      throw new AlreadyReportedError();\r\n    });\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    if (this._enableParallelism) {\r\n      this._parallelismParameter = this.defineStringParameter({\r\n        parameterLongName: '--parallelism',\r\n        parameterShortName: '-p',\r\n        argumentName: 'COUNT',\r\n        description: 'Specify the number of concurrent build processes'\r\n          + ' The value \"max\" can be specified to indicate the number of CPU cores.'\r\n          + ' If this parameter omitted, the default value depends on the operating system and number of CPU cores.'\r\n      });\r\n    }\r\n    this._toFlag = this.defineStringListParameter({\r\n      parameterLongName: '--to',\r\n      parameterShortName: '-t',\r\n      argumentName: 'PROJECT1',\r\n      description: 'Run command in the specified project and all of its dependencies'\r\n    });\r\n    this._fromVersionPolicy =  this.defineStringListParameter({\r\n      parameterLongName: '--from-version-policy',\r\n      argumentName: 'VERSION_POLICY_NAME',\r\n      description: 'Run command in all projects with the specified version policy '\r\n        + 'and all projects that directly or indirectly depend on projects with the specified version policy'\r\n    });\r\n    this._toVersionPolicy =  this.defineStringListParameter({\r\n      parameterLongName: '--to-version-policy',\r\n      argumentName: 'VERSION_POLICY_NAME',\r\n      description: 'Run command in all projects with the specified version policy and all of their dependencies'\r\n    });\r\n    this._fromFlag = this.defineStringListParameter({\r\n      parameterLongName: '--from',\r\n      parameterShortName: '-f',\r\n      argumentName: 'PROJECT2',\r\n      description: 'Run command in all projects that directly or indirectly depend on the specified project'\r\n    });\r\n    this._verboseParameter = this.defineFlagParameter({\r\n      parameterLongName: '--verbose',\r\n      parameterShortName: '-v',\r\n      description: 'Display the logs during the build, rather than just displaying the build status summary'\r\n    });\r\n    if (this._isIncrementalBuildAllowed) {\r\n      this._changedProjectsOnly = this.defineFlagParameter({\r\n        parameterLongName: '--changed-projects-only',\r\n        parameterShortName: '-o',\r\n        description: 'If specified, the incremental build will only rebuild projects that have changed, '\r\n          + 'but not any projects that directly or indirectly depend on the changed package.'\r\n      });\r\n    }\r\n\r\n    this.defineScriptParameters();\r\n  }\r\n\r\n  private _mergeProjectsWithVersionPolicy(flags: CommandLineStringListParameter,\r\n    versionPolicies: CommandLineStringListParameter): string[] {\r\n\r\n    const projects: string[] = [...flags.values];\r\n    if (versionPolicies.values && versionPolicies.values.length > 0) {\r\n      this.rushConfiguration.projects.forEach(project => {\r\n        const matches: boolean = versionPolicies.values.some(policyName => {\r\n          return project.versionPolicyName === policyName;\r\n        });\r\n        if (matches) {\r\n          projects.push(project.packageName);\r\n        }\r\n      });\r\n    }\r\n    return projects;\r\n  }\r\n\r\n  private _doBeforeTask(): void {\r\n    if (this.actionName !== 'build' && this.actionName !== 'rebuild') {\r\n      // Only collects information for built-in tasks like build or rebuild.\r\n      return;\r\n    }\r\n\r\n    SetupChecks.validate(this.rushConfiguration);\r\n\r\n    this.eventHooksManager.handle(Event.preRushBuild, this.parser.isDebug);\r\n  }\r\n\r\n  private _doAfterTask(stopwatch: Stopwatch, success: boolean): void {\r\n    if (this.actionName !== 'build' && this.actionName !== 'rebuild') {\r\n      // Only collects information for built-in tasks like build or rebuild.\r\n      return;\r\n    }\r\n    this._collectTelemetry(stopwatch, success);\r\n    this.parser.flushTelemetry();\r\n    this.eventHooksManager.handle(Event.postRushBuild, this.parser.isDebug);\r\n  }\r\n\r\n  private _collectTelemetry(stopwatch: Stopwatch, success: boolean): void {\r\n    const extraData: { [key: string]: string } = {\r\n      command_to: (this._toFlag.values.length > 0).toString(),\r\n      command_from: (this._fromFlag.values.length > 0).toString()\r\n    };\r\n\r\n    for (const customParameter of this.customParameters) {\r\n      switch (customParameter.kind) {\r\n        case CommandLineParameterKind.Flag:\r\n        case CommandLineParameterKind.Choice:\r\n        case CommandLineParameterKind.String:\r\n        case CommandLineParameterKind.Integer:\r\n          // tslint:disable-next-line:no-any\r\n          extraData[customParameter.longName] = JSON.stringify((customParameter as any).value);\r\n          break;\r\n        default:\r\n          extraData[customParameter.longName] = '?';\r\n      }\r\n    }\r\n\r\n    if (this.parser.telemetry) {\r\n      this.parser.telemetry.log({\r\n        name: this.actionName,\r\n        duration: stopwatch.duration,\r\n        result: success ? 'Succeeded' : 'Failed',\r\n        extraData\r\n      });\r\n    }\r\n  }\r\n}\r\n"]}