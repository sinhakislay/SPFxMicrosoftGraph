{"version":3,"file":"RushCommandLineParser.js","sourceRoot":"","sources":["../../src/cli/RushCommandLineParser.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as colors from 'colors';\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\n\r\nimport { CommandLineParser, CommandLineFlagParameter, CommandLineAction } from '@microsoft/ts-command-line';\r\nimport { InternalError } from '@microsoft/node-core-library';\r\n\r\nimport { RushConfiguration } from '../api/RushConfiguration';\r\nimport { RushConstants } from '../logic/RushConstants';\r\nimport { CommandLineConfiguration } from '../api/CommandLineConfiguration';\r\nimport { CommandJson } from '../api/CommandLineJson';\r\nimport { Utilities } from '../utilities/Utilities';\r\nimport { BaseScriptAction } from '../cli/scriptActions/BaseScriptAction';\r\n\r\nimport { AddAction } from './actions/AddAction';\r\nimport { ChangeAction } from './actions/ChangeAction';\r\nimport { CheckAction } from './actions/CheckAction';\r\nimport { UpdateAction } from './actions/UpdateAction';\r\nimport { InstallAction } from './actions/InstallAction';\r\nimport { InitAction } from './actions/InitAction';\r\nimport { LinkAction } from './actions/LinkAction';\r\nimport { ListAction } from './actions/ListAction';\r\nimport { PublishAction } from './actions/PublishAction';\r\nimport { PurgeAction } from './actions/PurgeAction';\r\nimport { UnlinkAction } from './actions/UnlinkAction';\r\nimport { ScanAction } from './actions/ScanAction';\r\nimport { VersionAction } from './actions/VersionAction';\r\n\r\nimport { BulkScriptAction } from './scriptActions/BulkScriptAction';\r\nimport { GlobalScriptAction } from './scriptActions/GlobalScriptAction';\r\n\r\nimport { Telemetry } from '../logic/Telemetry';\r\nimport { AlreadyReportedError } from '../utilities/AlreadyReportedError';\r\nimport { RushGlobalFolder } from '../api/RushGlobalFolder';\r\nimport { NodeJsCompatibility } from '../logic/NodeJsCompatibility';\r\n\r\n/**\r\n * Options for `RushCommandLineParser`.\r\n */\r\nexport interface IRushCommandLineParserOptions {\r\n  cwd: string;   // Defaults to `cwd`\r\n  alreadyReportedNodeTooNewError: boolean;\r\n}\r\n\r\nexport class RushCommandLineParser extends CommandLineParser {\r\n  public telemetry: Telemetry | undefined;\r\n  public rushGlobalFolder: RushGlobalFolder;\r\n  public rushConfiguration: RushConfiguration;\r\n\r\n  private _debugParameter: CommandLineFlagParameter;\r\n  private _rushOptions: IRushCommandLineParserOptions;\r\n\r\n  constructor(options?: Partial<IRushCommandLineParserOptions>) {\r\n    super({\r\n      toolFilename: 'rush',\r\n      toolDescription: 'Rush makes life easier for JavaScript developers who develop, build, and publish'\r\n        + ' many packages from a central Git repo.  It is designed to handle very large repositories'\r\n        + ' supporting many projects and people.  Rush provides policies, protections, and customizations'\r\n        + ' that help coordinate teams and safely onboard new contributors.  Rush also generates change logs'\r\n        + ' and automates package publishing.  It can manage decoupled subsets of projects with different'\r\n        + ' release and versioning strategies.  A full API is included to facilitate integration with other'\r\n        + ' automation tools.  If you are looking for a proven turnkey solution for monorepo management,'\r\n        + ' Rush is for you.'\r\n    });\r\n\r\n    this._rushOptions = this._normalizeOptions(options || {});\r\n\r\n    try {\r\n      const rushJsonFilename: string | undefined = RushConfiguration.tryFindRushJsonLocation({\r\n        startingFolder: this._rushOptions.cwd,\r\n        showVerbose: true\r\n      });\r\n      if (rushJsonFilename) {\r\n        this.rushConfiguration = RushConfiguration.loadFromConfigurationFile(rushJsonFilename);\r\n      }\r\n    } catch (error) {\r\n      this._reportErrorAndSetExitCode(error);\r\n    }\r\n\r\n    NodeJsCompatibility.warnAboutCompatibilityIssues({\r\n      isRushLib: true,\r\n      alreadyReportedNodeTooNewError: this._rushOptions.alreadyReportedNodeTooNewError,\r\n      rushConfiguration: this.rushConfiguration\r\n    });\r\n\r\n    this._populateActions();\r\n  }\r\n\r\n  public get isDebug(): boolean {\r\n    return this._debugParameter.value;\r\n  }\r\n\r\n  public flushTelemetry(): void {\r\n    if (this.telemetry) {\r\n      this.telemetry.flush();\r\n    }\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    this._debugParameter = this.defineFlagParameter({\r\n      parameterLongName: '--debug',\r\n      parameterShortName: '-d',\r\n      description: 'Show the full call stack if an error occurs while executing the tool'\r\n    });\r\n  }\r\n\r\n  protected onExecute(): Promise<void> {\r\n    // Defensively set the exit code to 1 so if Rush crashes for whatever reason, we'll have a nonzero exit code.\r\n    // For example, Node.js currently has the inexcusable design of terminating with zero exit code when\r\n    // there is an uncaught promise exception.  This will supposedly be fixed in Node.js 9.\r\n    // Ideally we should do this for all the Rush actions, but \"rush build\" is the most critical one\r\n    // -- if it falsely appears to succeed, we could merge bad PRs, publish empty packages, etc.\r\n    process.exitCode = 1;\r\n\r\n    if (this._debugParameter.value) {\r\n      InternalError.breakInDebugger = true;\r\n    }\r\n\r\n    return this._wrapOnExecute().catch((error: Error) => {\r\n      this._reportErrorAndSetExitCode(error);\r\n    }).then(() => {\r\n      // If we make it here, everything went fine, so reset the exit code back to 0\r\n      process.exitCode = 0;\r\n    });\r\n  }\r\n\r\n  private _normalizeOptions(options: Partial<IRushCommandLineParserOptions>): IRushCommandLineParserOptions {\r\n    return {\r\n      cwd: options.cwd || process.cwd(),\r\n      alreadyReportedNodeTooNewError: options.alreadyReportedNodeTooNewError || false\r\n    };\r\n  }\r\n\r\n  private _wrapOnExecute(): Promise<void> {\r\n    try {\r\n      if (this.rushConfiguration) {\r\n        this.telemetry = new Telemetry(this.rushConfiguration);\r\n      }\r\n      return super.onExecute().then(() => {\r\n        if (this.telemetry) {\r\n          this.flushTelemetry();\r\n        }\r\n      });\r\n    } catch (error) {\r\n      return Promise.reject(error);\r\n    }\r\n  }\r\n\r\n  private _populateActions(): void {\r\n    try {\r\n      this.rushGlobalFolder = new RushGlobalFolder();\r\n\r\n      this.addAction(new AddAction(this));\r\n      this.addAction(new ChangeAction(this));\r\n      this.addAction(new CheckAction(this));\r\n      this.addAction(new InstallAction(this));\r\n      this.addAction(new InitAction(this));\r\n      this.addAction(new LinkAction(this));\r\n      this.addAction(new ListAction(this));\r\n      this.addAction(new PublishAction(this));\r\n      this.addAction(new PurgeAction(this));\r\n      this.addAction(new ScanAction(this));\r\n      this.addAction(new UpdateAction(this));\r\n      this.addAction(new UnlinkAction(this));\r\n      this.addAction(new VersionAction(this));\r\n\r\n      this._populateScriptActions();\r\n\r\n    } catch (error) {\r\n      this._reportErrorAndSetExitCode(error);\r\n    }\r\n  }\r\n\r\n  private _populateScriptActions(): void {\r\n    let commandLineConfiguration: CommandLineConfiguration | undefined = undefined;\r\n\r\n    // If there is not a rush.json file, we still want \"build\" and \"rebuild\" to appear in the\r\n    // command-line help\r\n    if (this.rushConfiguration) {\r\n      const commandLineConfigFile: string = path.join(\r\n        this.rushConfiguration.commonRushConfigFolder,\r\n        RushConstants.commandLineFilename\r\n      );\r\n\r\n      commandLineConfiguration = CommandLineConfiguration.loadFromFileOrDefault(commandLineConfigFile);\r\n    }\r\n\r\n    // Build actions from the command line configuration supercede default build actions.\r\n    this._addCommandLineConfigActions(commandLineConfiguration);\r\n    this._addDefaultBuildActions(commandLineConfiguration);\r\n    this._validateCommandLineConfigParameterAssociations(commandLineConfiguration);\r\n  }\r\n\r\n  private _addDefaultBuildActions(commandLineConfiguration?: CommandLineConfiguration): void {\r\n    if (!this.tryGetAction('build')) {\r\n      // always create a build and a rebuild command\r\n      this.addAction(new BulkScriptAction({\r\n        actionName: 'build',\r\n        summary: '(EXPERIMENTAL) Build all projects that haven\\'t been built, or have changed since they were last '\r\n          + 'built.',\r\n        documentation: 'This command is similar to \"rush rebuild\", except that \"rush build\" performs'\r\n          + ' an incremental build. In other words, it only builds projects whose source files have changed'\r\n          + ' since the last successful build. The analysis requires a Git working tree, and only considers'\r\n          + ' source files that are tracked by Git and whose path is under the project folder. (For more details'\r\n          + ' about this algorithm, see the documentation for the \"package-deps-hash\" NPM package.) The incremental'\r\n          + ' build state is tracked in a per-project folder called \".rush/temp\" which should NOT be added to Git. The'\r\n          + ' build command is tracked by the \"arguments\" field in the \"package-deps_build.json\" file contained'\r\n          + ' therein; a full rebuild is forced whenever the command has changed (e.g. \"--production\" or not).',\r\n        parser: this,\r\n        commandLineConfiguration: commandLineConfiguration,\r\n\r\n        enableParallelism: true,\r\n        ignoreMissingScript: false,\r\n        ignoreDependencyOrder: false,\r\n        incremental: true,\r\n        allowWarningsInSuccessfulBuild: false\r\n      }));\r\n    }\r\n\r\n    if (!this.tryGetAction('rebuild')) {\r\n      this.addAction(new BulkScriptAction({\r\n        actionName: 'rebuild',\r\n        // To remain compatible with existing repos, `rebuild` defaults to calling the `build` command in each repo.\r\n        commandToRun: 'build',\r\n        summary: 'Clean and rebuild the entire set of projects',\r\n        documentation: 'This command assumes that the package.json file for each project contains'\r\n          + ' a \"scripts\" entry for \"npm run build\" that performs a full clean build.'\r\n          + ' Rush invokes this script to build each project that is registered in rush.json.'\r\n          + ' Projects are built in parallel where possible, but always respecting the dependency'\r\n          + ' graph for locally linked projects.  The number of simultaneous processes will be'\r\n          + ' based on the number of machine cores unless overridden by the --parallelism flag.'\r\n          + ' (For an incremental build, see \"rush build\" instead of \"rush rebuild\".)',\r\n        parser: this,\r\n        commandLineConfiguration: commandLineConfiguration,\r\n\r\n        enableParallelism: true,\r\n        ignoreMissingScript: false,\r\n        ignoreDependencyOrder: false,\r\n        incremental: false,\r\n        allowWarningsInSuccessfulBuild: false\r\n      }));\r\n    }\r\n  }\r\n\r\n  private _addCommandLineConfigActions(commandLineConfiguration?: CommandLineConfiguration): void {\r\n    if (!commandLineConfiguration) {\r\n      return;\r\n    }\r\n\r\n    // Register each custom command\r\n    for (const command of commandLineConfiguration.commands) {\r\n      if (this.tryGetAction(command.name)) {\r\n        throw new Error(`${RushConstants.commandLineFilename} defines a command \"${command.name}\"`\r\n          + ` using a name that already exists`);\r\n      }\r\n\r\n      this._validateCommandLineConfigCommand(command);\r\n\r\n      switch (command.commandKind) {\r\n        case 'bulk':\r\n          this.addAction(new BulkScriptAction({\r\n            actionName: command.name,\r\n            summary: command.summary,\r\n            documentation: command.description || command.summary,\r\n            safeForSimultaneousRushProcesses: command.safeForSimultaneousRushProcesses,\r\n\r\n            parser: this,\r\n            commandLineConfiguration: commandLineConfiguration,\r\n\r\n            enableParallelism: command.enableParallelism,\r\n            ignoreMissingScript: command.ignoreMissingScript || false,\r\n            ignoreDependencyOrder: command.ignoreDependencyOrder || false,\r\n            incremental: command.incremental || false,\r\n            allowWarningsInSuccessfulBuild: !!command.allowWarningsInSuccessfulBuild\r\n          }));\r\n          break;\r\n        case 'global':\r\n          this.addAction(new GlobalScriptAction({\r\n            actionName: command.name,\r\n            summary: command.summary,\r\n            documentation: command.description || command.summary,\r\n            safeForSimultaneousRushProcesses: command.safeForSimultaneousRushProcesses,\r\n\r\n            parser: this,\r\n            commandLineConfiguration: commandLineConfiguration,\r\n\r\n            shellCommand: command.shellCommand\r\n          }));\r\n          break;\r\n        default:\r\n          throw new Error(`${RushConstants.commandLineFilename} defines a command \"${command!.name}\"`\r\n            + ` using an unsupported command kind \"${command!.commandKind}\"`);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _validateCommandLineConfigParameterAssociations(commandLineConfiguration?: CommandLineConfiguration): void {\r\n    if (!commandLineConfiguration) {\r\n      return;\r\n    }\r\n\r\n    // Check for any invalid associations\r\n    for (const parameter of commandLineConfiguration.parameters) {\r\n      for (const associatedCommand of parameter.associatedCommands) {\r\n        const action: CommandLineAction | undefined = this.tryGetAction(associatedCommand);\r\n        if (!action) {\r\n          throw new Error(`${RushConstants.commandLineFilename} defines a parameter \"${parameter.longName}\"`\r\n            + ` that is associated with a nonexistent command \"${associatedCommand}\"`);\r\n        }\r\n        if (!(action instanceof BaseScriptAction)) {\r\n          throw new Error(`${RushConstants.commandLineFilename} defines a parameter \"${parameter.longName}\"`\r\n            + ` that is associated with a command \"${associatedCommand}\", but that command does not`\r\n            + ` support custom parameters`);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private _validateCommandLineConfigCommand(command: CommandJson): void {\r\n    // There are some restrictions on the 'build' and 'rebuild' commands.\r\n    if (command.name !== 'build' && command.name !== 'rebuild') {\r\n      return;\r\n    }\r\n\r\n    if (command.commandKind === 'global') {\r\n      throw new Error(`${RushConstants.commandLineFilename} defines a command \"${command.name}\" using ` +\r\n        `the command kind \"global\". This command can only be designated as a command kind \"bulk\".`);\r\n    }\r\n    if (command.safeForSimultaneousRushProcesses) {\r\n      throw new Error(`${RushConstants.commandLineFilename} defines a command \"${command.name}\" using ` +\r\n        `\"safeForSimultaneousRushProcesses=true\". This configuration is not supported for \"${command.name}\".`);\r\n    }\r\n  }\r\n\r\n  private _reportErrorAndSetExitCode(error: Error): void {\r\n    if (!(error instanceof AlreadyReportedError)) {\r\n      const prefix: string = 'ERROR: ';\r\n      console.error(os.EOL + colors.red(Utilities.wrapWords(prefix + error.message)));\r\n    }\r\n\r\n    if (this._debugParameter.value) {\r\n      // If catchSyncErrors() called this, then show a call stack similar to what Node.js\r\n      // would show for an uncaught error\r\n      console.error(os.EOL + error.stack);\r\n    }\r\n\r\n    this.flushTelemetry();\r\n\r\n    // Ideally we want to eliminate all calls to process.exit() from our code, and replace them\r\n    // with normal control flow that properly cleans up its data structures.\r\n    // For this particular call, we have a problem that the RushCommandLineParser constructor\r\n    // performs nontrivial work that can throw an exception.  Either the Rush class would need\r\n    // to handle reporting for those exceptions, or else _populateActions() should be moved\r\n    // to a RushCommandLineParser lifecycle stage that can handle it.\r\n    if (process.exitCode > 0) {\r\n      process.exit(process.exitCode);\r\n    } else {\r\n      process.exit(1);\r\n    }\r\n  }\r\n}\r\n"]}