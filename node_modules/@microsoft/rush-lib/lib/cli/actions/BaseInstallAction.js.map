{"version":3,"file":"BaseInstallAction.js","sourceRoot":"","sources":["../../../src/cli/actions/BaseInstallAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as colors from 'colors';\r\nimport * as os from 'os';\r\n\r\nimport {\r\n  CommandLineFlagParameter,\r\n  CommandLineIntegerParameter,\r\n  CommandLineStringParameter\r\n} from '@microsoft/ts-command-line';\r\n\r\nimport { BaseRushAction } from './BaseRushAction';\r\nimport { Event } from '../../api/EventHooks';\r\nimport { InstallManager, IInstallManagerOptions } from '../../logic/InstallManager';\r\nimport { PurgeManager } from '../../logic/PurgeManager';\r\nimport { SetupChecks } from '../../logic/SetupChecks';\r\nimport { StandardScriptUpdater } from '../../logic/StandardScriptUpdater';\r\nimport { Stopwatch } from '../../utilities/Stopwatch';\r\nimport { VersionMismatchFinder } from '../../logic/versionMismatch/VersionMismatchFinder';\r\nimport { Variants } from '../../api/Variants';\r\n\r\n/**\r\n * This is the common base class for InstallAction and UpdateAction.\r\n */\r\nexport abstract class BaseInstallAction extends BaseRushAction {\r\n  protected _variant: CommandLineStringParameter;\r\n  protected _purgeParameter: CommandLineFlagParameter;\r\n  protected _bypassPolicyParameter: CommandLineFlagParameter;\r\n  protected _noLinkParameter: CommandLineFlagParameter;\r\n  protected _networkConcurrencyParameter: CommandLineIntegerParameter;\r\n  protected _debugPackageManagerParameter: CommandLineFlagParameter;\r\n\r\n  protected onDefineParameters(): void {\r\n    this._purgeParameter = this.defineFlagParameter({\r\n      parameterLongName: '--purge',\r\n      parameterShortName: '-p',\r\n      description: 'Perform \"rush purge\" before starting the installation'\r\n    });\r\n    this._bypassPolicyParameter = this.defineFlagParameter({\r\n      parameterLongName: '--bypass-policy',\r\n      description: 'Overrides enforcement of the \"gitPolicy\" rules from rush.json (use honorably!)'\r\n    });\r\n    this._noLinkParameter = this.defineFlagParameter({\r\n      parameterLongName: '--no-link',\r\n      description: 'If \"--no-link\" is specified, then project symlinks will NOT be created'\r\n        + ' after the installation completes.  You will need to run \"rush link\" manually.'\r\n        + ' This flag is useful for automated builds that want to report stages individually'\r\n        + ' or perform extra operations in between the two stages.'\r\n    });\r\n    this._networkConcurrencyParameter = this.defineIntegerParameter({\r\n      parameterLongName: '--network-concurrency',\r\n      argumentName: 'COUNT',\r\n      description: 'If specified, limits the maximum number of concurrent network requests.'\r\n        + '  This is useful when troubleshooting network failures.'\r\n    });\r\n    this._debugPackageManagerParameter = this.defineFlagParameter({\r\n      parameterLongName: '--debug-package-manager',\r\n      description: 'Activates verbose logging for the package manager. You will probably want to pipe'\r\n        + ' the output of Rush to a file when using this command.'\r\n    });\r\n    this._variant = this.defineStringParameter(Variants.VARIANT_PARAMETER);\r\n  }\r\n\r\n  protected abstract buildInstallOptions(): IInstallManagerOptions;\r\n\r\n  protected run(): Promise<void> {\r\n    VersionMismatchFinder.ensureConsistentVersions(this.rushConfiguration, {\r\n      variant: this._variant.value\r\n    });\r\n\r\n    const stopwatch: Stopwatch = Stopwatch.start();\r\n\r\n    SetupChecks.validate(this.rushConfiguration);\r\n    let warnAboutScriptUpdate: boolean = false;\r\n    if (this.actionName === 'update') {\r\n      warnAboutScriptUpdate = StandardScriptUpdater.update(this.rushConfiguration);\r\n    } else {\r\n      StandardScriptUpdater.validate(this.rushConfiguration);\r\n    }\r\n\r\n    this.eventHooksManager.handle(Event.preRushInstall, this.parser.isDebug);\r\n\r\n    const purgeManager: PurgeManager = new PurgeManager(this.rushConfiguration, this.rushGlobalFolder);\r\n\r\n    if (this._purgeParameter.value!) {\r\n      console.log('The --purge flag was specified, so performing \"rush purge\"');\r\n      purgeManager.purgeNormal();\r\n      console.log('');\r\n    }\r\n\r\n    if (this._networkConcurrencyParameter.value) {\r\n      if (this.rushConfiguration.packageManager !== 'pnpm') {\r\n        throw new Error(`The \"${this._networkConcurrencyParameter.longName}\" parameter is`\r\n          + ` only supported when using the PNPM package manager.`);\r\n      }\r\n    }\r\n\r\n    const installManagerOptions: IInstallManagerOptions = this.buildInstallOptions();\r\n\r\n    const installManager: InstallManager = new InstallManager(\r\n      this.rushConfiguration,\r\n      this.rushGlobalFolder,\r\n      purgeManager,\r\n      installManagerOptions\r\n    );\r\n\r\n    return installManager.doInstall()\r\n      .then(() => {\r\n        purgeManager.deleteAll();\r\n        stopwatch.stop();\r\n\r\n        this._collectTelemetry(stopwatch, installManagerOptions, true);\r\n        this.eventHooksManager.handle(Event.postRushInstall, this.parser.isDebug);\r\n\r\n        if (warnAboutScriptUpdate) {\r\n          console.log(os.EOL + colors.yellow('Rush refreshed some files in the \"common/scripts\" folder.'\r\n            + '  Please commit this change to Git.'));\r\n        }\r\n\r\n        console.log(os.EOL + colors.green(\r\n          `Rush ${this.actionName} finished successfully. (${stopwatch.toString()})`));\r\n      })\r\n      .catch((error) => {\r\n        purgeManager.deleteAll();\r\n        stopwatch.stop();\r\n\r\n        this._collectTelemetry(stopwatch, installManagerOptions, false);\r\n        throw error;\r\n      });\r\n  }\r\n\r\n  private _collectTelemetry(stopwatch: Stopwatch, installManagerOptions: IInstallManagerOptions,\r\n    success: boolean): void {\r\n\r\n    if (this.parser.telemetry) {\r\n      this.parser.telemetry.log({\r\n        name: 'install',\r\n        duration: stopwatch.duration,\r\n        result: success ? 'Succeeded' : 'Failed',\r\n        extraData: {\r\n          mode: this.actionName,\r\n          clean: (!!this._purgeParameter.value).toString(),\r\n          full: installManagerOptions.fullUpgrade.toString()\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n}\r\n"]}