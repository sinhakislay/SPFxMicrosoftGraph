{"version":3,"file":"VersionAction.js","sourceRoot":"","sources":["../../../src/cli/actions/VersionAction.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;AAE3D,iCAAiC;AAUjC,2DAA0E;AAE1E,mEAAgE;AAChE,mEAAgE;AAChE,6FAA0F;AAE1F,wEAAqE;AACrE,qDAAkD;AAClD,+DAA4D;AAC5D,uDAAoD;AACpD,yCAAsC;AAEzB,QAAA,8BAA8B,GAAW,2BAA2B,CAAC;AAElF,MAAa,aAAc,SAAQ,+BAAc;IAY/C,YAAY,MAA6B;QACvC,KAAK,CAAC;YACJ,UAAU,EAAE,SAAS;YACrB,OAAO,EAAE,qDAAqD;YAC9D,aAAa,EAAE,8FAA8F;YAC7G,MAAM;SACP,CAAC,CAAC;IACL,CAAC;IAES,kBAAkB;QAC1B,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,qBAAqB,CAAC;YAC9C,iBAAiB,EAAE,iBAAiB;YACpC,kBAAkB,EAAE,IAAI;YACxB,YAAY,EAAE,QAAQ;YACtB,WAAW,EACX,yFAAyF;SAC1F,CAAC,CAAC;QACH,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAC,mBAAmB,CAAC;YACnD,iBAAiB,EAAE,yBAAyB;YAC5C,WAAW,EAAE,iEAAiE;SAC/E,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,qBAAqB,CAAC;YACjD,iBAAiB,EAAE,oBAAoB;YACvC,YAAY,EAAE,aAAa;YAC3B,WAAW,EAAE,0DAA0D;gBACrE,qGAAqG;SACxG,CAAC,CAAC;QACH,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,mBAAmB,CAAC;YAC3C,iBAAiB,EAAE,QAAQ;YAC3B,WAAW,EAAE,kDAAkD;SAChE,CAAC,CAAC;QACH,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,mBAAmB,CAAC;YAC5C,iBAAiB,EAAE,iBAAiB;YACpC,WAAW,EAAE,oDAAoD;SAClE,CAAC,CAAC;QACH,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,qBAAqB,CAAC;YAC/C,iBAAiB,EAAE,kBAAkB;YACrC,YAAY,EAAE,QAAQ;YACtB,WAAW,EAAE,gCAAgC;SAC9C,CAAC,CAAC;QACH,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,qBAAqB,CAAC;YAC/C,iBAAiB,EAAE,iBAAiB;YACpC,YAAY,EAAE,UAAU;YACxB,WAAW,EAAE,sFAAsF;gBACjG,4EAA4E;gBAC5E,sEAAsE;SACzE,CAAC,CAAC;QACH,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC,qBAAqB,CAAC;YACtD,iBAAiB,EAAE,0BAA0B;YAC7C,YAAY,EAAE,IAAI;YAClB,WAAW,EAAE,kFAAkF;gBAC7F,oCAAoC;gBACpC,wDAAwD;gBACxD,8FAA8F;gBAC9F,6DAA6D;SAChE,CAAC,CAAC;IACL,CAAC;IAES,GAAG;QACX,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,GAAG,EAAE;YACjC,iCAAe,CAAC,cAAc,CAAC,IAAI,CAAC,iBAAiB,EAAE,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YACjF,MAAM,SAAS,GAAW,SAAG,CAAC,WAAW,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;YAElE,IAAI,CAAC,cAAc,EAAE,CAAC;YAEtB,IAAI,CAAC,eAAe,GAAG,IAAI,+BAAc,CAAC,IAAI,CAAC,iBAAiB,EAAE,SAAS,CAAC,CAAC;YAE7E,IAAI,IAAI,CAAC,oBAAoB,CAAC,KAAK,EAAE;gBACnC,IAAI,CAAC,+BAA+B,EAAE,CAAC;gBACvC,MAAM,UAAU,GAAW,iBAAiB,GAAG,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,CAAC;gBACpE,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,EAAE,IAAI,EACzD,CAAC,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,IAAI,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC,KAAK,CAAC,CAAC;gBAEvE,MAAM,eAAe,GAA8B,IAAI,CAAC,eAAe,CAAC,eAAe,CAAC;gBACxF,IAAI,eAAe,CAAC,IAAI,GAAG,CAAC,EAAE;oBAC5B,OAAO,CAAC,GAAG,CAAC,GAAG,eAAe,CAAC,IAAI,gCAAgC,CAAC,CAAC;oBACrE,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;iBAC9B;aACF;iBAAM,IAAI,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE;gBAClC,MAAM,UAAU,GAAW,eAAe,GAAG,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,CAAC;gBAClE,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,EACjD,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,CAAC,wBAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,EAC3E,IAAI,CAAC,qBAAqB,CAAC,KAAK,EAChC,IAAI,CAAC,CAAC;gBACR,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;aAC9B;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,+BAA+B;QACrC,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC,qBAAqB,CAAC,KAAK,EAAE;YACrE,sCAAsC;YACtC,OAAO;SACR;QACD,IAAI,IAAI,CAAC,gBAAgB,CAAC,KAAK,IAAI,IAAI,CAAC,qBAAqB,CAAC,KAAK,EAAE;YACnE,MAAM,IAAI,KAAK,CAAC,yCAAyC;gBACvD,sDAAsD,CAAC,CAAC;SAC3D;QAED,IAAI,IAAI,CAAC,cAAc,CAAC,KAAK,EAAE;YAC7B,MAAM,aAAa,GAA+B,IAAI,CAAC,iBAAiB,CAAC,0BAA0B,CAAC;YACpG,MAAM,MAAM,GAA0B,aAAa,CAAC,gBAAgB,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CACrE,CAAC;YAC1B,IAAI,CAAC,MAAM,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE;gBACpC,MAAM,IAAI,KAAK,CAAC,gCAAgC,MAAM,CAAC,UAAU,iBAAiB,CAAC,CAAC;aACrF;YACD,IAAI,UAAU,GAAuB,SAAS,CAAC;YAC/C,IAAI,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE;gBAC/B,UAAU,GAAG,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC;aAC1C;iBAAM,IAAI,IAAI,CAAC,qBAAqB,CAAC,KAAK,EAAE;gBAC3C,MAAM,gBAAgB,GAAkB,IAAI,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;gBAC1E,IAAI,gBAAgB,CAAC,UAAU,CAAC,MAAM,EAAE;oBACtC,yCAAyC;oBACzC,gBAAgB,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,qBAAqB,CAAC,KAAK,CAAC;iBACnE;qBAAM;oBACL,6BAA6B;oBAC7B,gBAAgB,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,qBAAqB,CAAC,KAAK,CAAC,CAAC;iBACpE;gBACD,UAAU,GAAG,gBAAgB,CAAC,MAAM,EAAE,CAAC;aACxC;YAED,IAAI,UAAU,EAAE;gBACd,OAAO,CAAC,GAAG,CAAC,yBAAyB,MAAM,CAAC,UAAU,SAAS,MAAM,CAAC,OAAO,OAAO,UAAU,EAAE,CAAC,CAAC;gBAClG,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC;aAC7D;SACF;aAAM;YACL,MAAM,IAAI,KAAK,CAAC,2FAA2F,CAAC,CAAC;SAC9G;IACH,CAAC;IAEO,cAAc;QACpB,IAAI,IAAI,CAAC,YAAY,CAAC,KAAK,IAAI,IAAI,CAAC,oBAAoB,CAAC,KAAK,EAAE;YAC9D,MAAM,IAAI,KAAK,CAAC,mEAAmE,CAAC,CAAC;SACtF;QAED,IAAI,IAAI,CAAC,cAAc,CAAC,KAAK,IAAI,CAAC,wBAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,EAAE;YACrE,MAAM,IAAI,KAAK,CAAC,4CAA4C;gBAC5D,oEAAoE,CAAC,CAAC;SACvE;IACH,CAAC;IAEO,eAAe;QACrB,wEAAwE;QACxE,MAAM,UAAU,GAAsB,qCAAiB,CAAC,yBAAyB,CAC/E,IAAI,CAAC,iBAAiB,CAAC,YAAY,CACpC,CAAC;QAEF,MAAM,cAAc,GAA0B,6CAAqB,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;QAC9F,IAAI,cAAc,CAAC,kBAAkB,EAAE;YACrC,MAAM,IAAI,KAAK,CAAC,yEAAyE;gBACvF,2CAA2C,CAAC,CAAC;SAChD;IACH,CAAC;IAEO,WAAW,CAAC,UAAkB;QACpC,qCAAqC;QACrC,IAAI,CAAC,eAAe,EAAE,CAAC;QAEvB,MAAM,GAAG,GAAe,IAAI,uBAAU,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAEjE,+BAA+B;QAC/B,GAAG,CAAC,QAAQ,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;QAE/B,MAAM,kBAAkB,GAA0B,+BAAc,CAAC,qBAAqB,EAAE,CAAC;QAEzF,6DAA6D;QAC7D,0DAA0D;QAC1D,MAAM,gBAAgB,GAAY,kBAAkB,CAAC,IAAI,CAAC,CAAC,UAAU,EAAE,EAAE;YACvE,OAAO,UAAU,CAAC,OAAO,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC;QAClD,CAAC,CAAC,CAAC;QAEH,IAAI,gBAAgB,EAAE;YACpB,GAAG,CAAC,UAAU,CAAC,GAAG,EAAE,IAAI,CAAC,iBAAiB,CAAC,aAAa,CAAC,CAAC;YAC1D,GAAG,CAAC,UAAU,CAAC,qBAAqB,CAAC,CAAC;YACtC,GAAG,CAAC,UAAU,CAAC,mBAAmB,CAAC,CAAC;YACpC,GAAG,CAAC,MAAM,CAAC,qEAAqE,CAAC,CAAC;SACnF;QAED,oDAAoD;QACpD,MAAM,kBAAkB,GAAY,kBAAkB,CAAC,IAAI,CAAC,CAAC,UAAU,EAAE,EAAE;YACzE,OAAO,UAAU,CAAC,OAAO,kCAA2B,GAAG,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC;QAEH,IAAI,kBAAkB,EAAE;YACtB,GAAG,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;YACtB,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,iBAAiB,CAAC,2BAA2B,IAAI,sCAA8B,CAAC,CAAC;SAClG;QAED,IAAI,gBAAgB,IAAI,kBAAkB,EAAE;YAC1C,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YAErB,8BAA8B;YAC9B,GAAG,CAAC,KAAK,EAAE,CAAC;YACZ,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YACvC,GAAG,CAAC,IAAI,EAAE,CAAC;YACX,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;YACtB,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YACnC,GAAG,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;SAC9B;aAAM;YACL,eAAe;YACf,GAAG,CAAC,KAAK,EAAE,CAAC;YACZ,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YACvC,GAAG,CAAC,YAAY,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;SACrC;IACH,CAAC;CACF;AAzND,sCAyNC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as semver from 'semver';\r\nimport {\r\n  IPackageJson,\r\n  FileConstants\r\n} from '@microsoft/node-core-library';\r\nimport {\r\n  CommandLineFlagParameter,\r\n  CommandLineStringParameter\r\n} from '@microsoft/ts-command-line';\r\n\r\nimport { BumpType, LockStepVersionPolicy } from '../../api/VersionPolicy';\r\nimport { VersionPolicyConfiguration } from '../../api/VersionPolicyConfiguration';\r\nimport { RushConfiguration } from '../../api/RushConfiguration';\r\nimport { VersionControl } from '../../utilities/VersionControl';\r\nimport { VersionMismatchFinder } from '../../logic/versionMismatch/VersionMismatchFinder';\r\nimport { RushCommandLineParser } from '../RushCommandLineParser';\r\nimport { PolicyValidator } from '../../logic/policy/PolicyValidator';\r\nimport { BaseRushAction } from './BaseRushAction';\r\nimport { VersionManager } from '../../logic/VersionManager';\r\nimport { PublishGit } from '../../logic/PublishGit';\r\nimport { Git } from '../../logic/Git';\r\n\r\nexport const DEFAULT_PACKAGE_UPDATE_MESSAGE: string = 'Applying package updates.';\r\n\r\nexport class VersionAction extends BaseRushAction {\r\n  private _ensureVersionPolicy: CommandLineFlagParameter;\r\n  private _overrideVersion: CommandLineStringParameter;\r\n  private _bumpVersion: CommandLineFlagParameter;\r\n  private _versionPolicy: CommandLineStringParameter;\r\n  private _bypassPolicy: CommandLineFlagParameter;\r\n  private _targetBranch: CommandLineStringParameter;\r\n  private _overwriteBump: CommandLineStringParameter;\r\n  private _prereleaseIdentifier: CommandLineStringParameter;\r\n\r\n  private _versionManager: VersionManager;\r\n\r\n  constructor(parser: RushCommandLineParser) {\r\n    super({\r\n      actionName: 'version',\r\n      summary: '(EXPERIMENTAL) Manage package versions in the repo.',\r\n      documentation: '(EXPERIMENTAL) use this \"rush version\" command to ensure version policies and bump versions.',\r\n      parser\r\n    });\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    this._targetBranch = this.defineStringParameter({\r\n      parameterLongName: '--target-branch',\r\n      parameterShortName: '-b',\r\n      argumentName: 'BRANCH',\r\n      description:\r\n      'If this flag is specified, changes will be committed and merged into the target branch.'\r\n    });\r\n    this._ensureVersionPolicy = this.defineFlagParameter({\r\n      parameterLongName: '--ensure-version-policy',\r\n      description: 'Updates package versions if needed to satisfy version policies.'\r\n    });\r\n    this._overrideVersion = this.defineStringParameter({\r\n      parameterLongName: '--override-version',\r\n      argumentName: 'NEW_VERSION',\r\n      description: 'Override the version in the specified --version-policy. ' +\r\n        'This setting only works for lock-step version policy and when --ensure-version-policy is specified.'\r\n    });\r\n    this._bumpVersion = this.defineFlagParameter({\r\n      parameterLongName: '--bump',\r\n      description: 'Bumps package version based on version policies.'\r\n    });\r\n    this._bypassPolicy = this.defineFlagParameter({\r\n      parameterLongName: '--bypass-policy',\r\n      description: 'Overrides \"gitPolicy\" enforcement (use honorably!)'\r\n    });\r\n    this._versionPolicy = this.defineStringParameter({\r\n      parameterLongName: '--version-policy',\r\n      argumentName: 'POLICY',\r\n      description: 'The name of the version policy'\r\n    });\r\n    this._overwriteBump = this.defineStringParameter({\r\n      parameterLongName: '--override-bump',\r\n      argumentName: 'BUMPTYPE',\r\n      description: 'Overrides the bump type in the version-policy.json for the specified version policy.' +\r\n        'Valid BUMPTYPE values include: prerelease, patch, preminor, minor, major. ' +\r\n        'This setting only works for lock-step version policy in bump action.'\r\n    });\r\n    this._prereleaseIdentifier = this.defineStringParameter({\r\n      parameterLongName: '--override-prerelease-id',\r\n      argumentName: 'ID',\r\n      description: 'Overrides the prerelease identifier in the version value of version-policy.json ' +\r\n        'for the specified version policy. ' +\r\n        'This setting only works for lock-step version policy. ' +\r\n        'This setting increases to new prerelease id when \"--bump\" is provided but only replaces the ' +\r\n        'prerelease name when \"--ensure-version-policy\" is provided.'\r\n    });\r\n  }\r\n\r\n  protected run(): Promise<void> {\r\n    return Promise.resolve().then(() => {\r\n      PolicyValidator.validatePolicy(this.rushConfiguration, this._bypassPolicy.value);\r\n      const userEmail: string = Git.getGitEmail(this.rushConfiguration);\r\n\r\n      this._validateInput();\r\n\r\n      this._versionManager = new VersionManager(this.rushConfiguration, userEmail);\r\n\r\n      if (this._ensureVersionPolicy.value) {\r\n        this._overwritePolicyVersionIfNeeded();\r\n        const tempBranch: string = 'version/ensure-' + new Date().getTime();\r\n        this._versionManager.ensure(this._versionPolicy.value, true,\r\n          !!this._overrideVersion.value || !!this._prereleaseIdentifier.value);\r\n\r\n        const updatedPackages: Map<string, IPackageJson> = this._versionManager.updatedProjects;\r\n        if (updatedPackages.size > 0) {\r\n          console.log(`${updatedPackages.size} packages are getting updated.`);\r\n          this._gitProcess(tempBranch);\r\n        }\r\n      } else if (this._bumpVersion.value) {\r\n        const tempBranch: string = 'version/bump-' + new Date().getTime();\r\n        this._versionManager.bump(this._versionPolicy.value,\r\n          this._overwriteBump.value ? BumpType[this._overwriteBump.value] : undefined,\r\n          this._prereleaseIdentifier.value,\r\n          true);\r\n        this._gitProcess(tempBranch);\r\n      }\r\n    });\r\n  }\r\n\r\n  private _overwritePolicyVersionIfNeeded(): void {\r\n    if (!this._overrideVersion.value && !this._prereleaseIdentifier.value) {\r\n      // No need to overwrite policy version\r\n      return;\r\n    }\r\n    if (this._overrideVersion.value && this._prereleaseIdentifier.value) {\r\n      throw new Error(`The parameters \"--override-version\" and` +\r\n        ` \"--override-prerelease-id\" cannot be used together.`);\r\n    }\r\n\r\n    if (this._versionPolicy.value) {\r\n      const versionConfig: VersionPolicyConfiguration = this.rushConfiguration.versionPolicyConfiguration;\r\n      const policy: LockStepVersionPolicy = versionConfig.getVersionPolicy(this._versionPolicy.value) as\r\n          LockStepVersionPolicy;\r\n      if (!policy || !policy.isLockstepped) {\r\n        throw new Error(`The lockstep version policy \"${policy.policyName}\" is not found.`);\r\n      }\r\n      let newVersion: string | undefined = undefined;\r\n      if (this._overrideVersion.value) {\r\n        newVersion = this._overrideVersion.value;\r\n      } else if (this._prereleaseIdentifier.value) {\r\n        const newPolicyVersion: semver.SemVer = new semver.SemVer(policy.version);\r\n        if (newPolicyVersion.prerelease.length) {\r\n          // Update 1.5.0-alpha.10 to 1.5.0-beta.10\r\n          newPolicyVersion.prerelease[0] = this._prereleaseIdentifier.value;\r\n        } else {\r\n          // Update 1.5.0 to 1.5.0-beta\r\n          newPolicyVersion.prerelease.push(this._prereleaseIdentifier.value);\r\n        }\r\n        newVersion = newPolicyVersion.format();\r\n      }\r\n\r\n      if (newVersion) {\r\n        console.log(`Update version policy ${policy.policyName} from ${policy.version} to ${newVersion}`);\r\n        versionConfig.update(this._versionPolicy.value, newVersion);\r\n      }\r\n    } else {\r\n      throw new Error('Missing --version-policy parameter to specify which version policy should be overwritten.');\r\n    }\r\n  }\r\n\r\n  private _validateInput(): void {\r\n    if (this._bumpVersion.value && this._ensureVersionPolicy.value) {\r\n      throw new Error('Please choose --bump or --ensure-version-policy but not together.');\r\n    }\r\n\r\n    if (this._overwriteBump.value && !BumpType[this._overwriteBump.value]) {\r\n      throw new Error('The value of override-bump is not valid.  ' +\r\n      'Valid values include prerelease, patch, preminor, minor, and major');\r\n    }\r\n  }\r\n\r\n  private _validateResult(): void {\r\n    // Load the config from file to avoid using inconsistent in-memory data.\r\n    const rushConfig: RushConfiguration = RushConfiguration.loadFromConfigurationFile(\r\n      this.rushConfiguration.rushJsonFile\r\n    );\r\n\r\n    const mismatchFinder: VersionMismatchFinder = VersionMismatchFinder.getMismatches(rushConfig);\r\n    if (mismatchFinder.numberOfMismatches) {\r\n      throw new Error('Unable to finish version bump because inconsistencies were encountered.' +\r\n        ' Run \\\"rush check\\\" to find more details.');\r\n    }\r\n  }\r\n\r\n  private _gitProcess(tempBranch: string): void {\r\n    // Validate the result before commit.\r\n    this._validateResult();\r\n\r\n    const git: PublishGit = new PublishGit(this._targetBranch.value);\r\n\r\n    // Make changes in temp branch.\r\n    git.checkout(tempBranch, true);\r\n\r\n    const uncommittedChanges: ReadonlyArray<string> = VersionControl.getUncommittedChanges();\r\n\r\n    // Stage, commit, and push the changes to remote temp branch.\r\n    // Need to commit the change log updates in its own commit\r\n    const changeLogUpdated: boolean = uncommittedChanges.some((changePath) => {\r\n      return changePath.indexOf('CHANGELOG.json') > 0;\r\n    });\r\n\r\n    if (changeLogUpdated) {\r\n      git.addChanges('.', this.rushConfiguration.changesFolder);\r\n      git.addChanges(':/**/CHANGELOG.json');\r\n      git.addChanges(':/**/CHANGELOG.md');\r\n      git.commit('Deleting change files and updating change logs for package updates.');\r\n    }\r\n\r\n    // Commit the package.json and change files updates.\r\n    const packageJsonUpdated: boolean = uncommittedChanges.some((changePath) => {\r\n      return changePath.indexOf(FileConstants.PackageJson) > 0;\r\n    });\r\n\r\n    if (packageJsonUpdated) {\r\n      git.addChanges(':/*');\r\n      git.commit(this.rushConfiguration.gitVersionBumpCommitMessage || DEFAULT_PACKAGE_UPDATE_MESSAGE);\r\n    }\r\n\r\n    if (changeLogUpdated || packageJsonUpdated) {\r\n      git.push(tempBranch);\r\n\r\n      // Now merge to target branch.\r\n      git.fetch();\r\n      git.checkout(this._targetBranch.value);\r\n      git.pull();\r\n      git.merge(tempBranch);\r\n      git.push(this._targetBranch.value);\r\n      git.deleteBranch(tempBranch);\r\n    } else {\r\n      // skip commits\r\n      git.fetch();\r\n      git.checkout(this._targetBranch.value);\r\n      git.deleteBranch(tempBranch, false);\r\n    }\r\n  }\r\n}\r\n"]}