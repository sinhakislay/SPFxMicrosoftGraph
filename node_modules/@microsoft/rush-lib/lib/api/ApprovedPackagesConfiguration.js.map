{"version":3,"file":"ApprovedPackagesConfiguration.js","sourceRoot":"","sources":["../../src/api/ApprovedPackagesConfiguration.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport * as os from 'os';\r\nimport { JsonFile, JsonSchema, FileSystem, NewlineKind, InternalError } from '@microsoft/node-core-library';\r\n\r\nimport { Utilities } from '../utilities/Utilities';\r\nimport { JsonSchemaUrls } from '../logic/JsonSchemaUrls';\r\n\r\n/**\r\n * Part of IApprovedPackagesJson.\r\n */\r\nexport interface IApprovedPackagesItemJson {\r\n  name: string;\r\n  allowedCategories: string[];\r\n}\r\n\r\n/**\r\n * This represents the JSON data structure for the \"browser-approved-packages.json\"\r\n * and \"nonbrowser-approved-packages.json\" configuration files.  See \"approved-packages.schema.json\"\r\n * for documentation.\r\n */\r\nexport interface IApprovedPackagesJson {\r\n  $schema?: string;\r\n  packages: IApprovedPackagesItemJson[];\r\n}\r\n\r\n/**\r\n * An item returned by ApprovedPackagesConfiguration\r\n * @public\r\n */\r\nexport class ApprovedPackagesItem {\r\n  /**\r\n   * The NPM package name\r\n   */\r\n  public packageName: string;\r\n\r\n  /**\r\n   * The project categories that are allowed to use this package.\r\n   */\r\n  public allowedCategories: Set<string> = new Set<string>();\r\n}\r\n\r\n/**\r\n * This represents the JSON file specified via the \"approvedPackagesFile\" option in rush.json.\r\n * @public\r\n */\r\nexport class ApprovedPackagesConfiguration {\r\n  private static _jsonSchema: JsonSchema = JsonSchema.fromFile(\r\n    path.join(__dirname, '../schemas/approved-packages.schema.json'));\r\n\r\n  public items: ApprovedPackagesItem[] = [];\r\n\r\n  private _itemsByName: Map<string, ApprovedPackagesItem> = new Map<string, ApprovedPackagesItem>();\r\n\r\n  private _loadedJson: IApprovedPackagesJson;\r\n  private _jsonFilename: string;\r\n\r\n  public constructor(jsonFilename: string) {\r\n    this._jsonFilename = jsonFilename;\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Clears all the settings, returning to an empty state.\r\n   */\r\n  public clear(): void {\r\n    this._itemsByName.clear();\r\n    this._loadedJson = {\r\n      // Ensure this comes first in the key ordering\r\n      $schema: '',\r\n      packages: []\r\n    };\r\n  }\r\n\r\n  public getItemByName(packageName: string): ApprovedPackagesItem | undefined {\r\n    return this._itemsByName.get(packageName);\r\n  }\r\n\r\n  public addOrUpdatePackage(packageName: string, reviewCategory: string): boolean {\r\n    let changed: boolean = false;\r\n\r\n    let item: ApprovedPackagesItem | undefined = this._itemsByName.get(packageName);\r\n    if (!item) {\r\n      item = new ApprovedPackagesItem();\r\n      item.packageName = packageName;\r\n      this._addItem(item);\r\n      changed = true;\r\n    }\r\n\r\n    if (reviewCategory && !item.allowedCategories.has(reviewCategory)) {\r\n      item.allowedCategories.add(reviewCategory);\r\n      changed = true;\r\n    }\r\n\r\n    return changed;\r\n  }\r\n\r\n  /**\r\n   * If the file exists, calls loadFromFile().\r\n   */\r\n  public tryLoadFromFile(approvedPackagesPolicyEnabled: boolean): boolean {\r\n    if (!FileSystem.exists(this._jsonFilename)) {\r\n      return false;\r\n    }\r\n\r\n    this.loadFromFile();\r\n\r\n    if (!approvedPackagesPolicyEnabled) {\r\n      console.log(`Warning: Ignoring \"${path.basename(this._jsonFilename)}\" because the`\r\n        + ` \"approvedPackagesPolicy\" setting was not specified in rush.json`);\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Loads the configuration data from the filename that was passed to the constructor.\r\n   */\r\n  public loadFromFile(): void {\r\n    const approvedPackagesJson: IApprovedPackagesJson = JsonFile.loadAndValidate(this._jsonFilename,\r\n      ApprovedPackagesConfiguration._jsonSchema);\r\n\r\n    this.clear();\r\n\r\n    for (const browserPackage of approvedPackagesJson.packages) {\r\n      this._addItemJson(browserPackage, this._jsonFilename);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loads the configuration data to the filename that was passed to the constructor.\r\n   */\r\n  public saveToFile(): void {\r\n    // Update the JSON structure that we already loaded, preserving any existing state\r\n    // (which passed schema validation).\r\n\r\n    this._loadedJson.$schema = JsonSchemaUrls.approvedPackages,\r\n\r\n    this._loadedJson.packages = [];\r\n\r\n    this.items.sort((a: ApprovedPackagesItem, b: ApprovedPackagesItem) => {\r\n      return a.packageName.localeCompare(b.packageName);\r\n    });\r\n\r\n    for (const item of this.items) {\r\n      // Sort the items from the set.  Too bad we can't use the new Array.from().\r\n      const allowedCategories: string[] = Utilities.getSetAsArray(item.allowedCategories);\r\n      allowedCategories.sort();\r\n\r\n      const itemJson: IApprovedPackagesItemJson = {\r\n        name: item.packageName,\r\n        allowedCategories: allowedCategories\r\n      };\r\n\r\n      this._loadedJson.packages.push(itemJson);\r\n    }\r\n\r\n    // Save the file\r\n    let body: string = JsonFile.stringify(this._loadedJson);\r\n\r\n    // Unindent the allowedCategories array to improve readability\r\n    body = body.replace(\r\n      /(\"allowedCategories\": +\\[)([^\\]]+)/g,\r\n      (substring: string, ...args: string[]) => {\r\n        return args[0] + args[1].replace(/\\s+/g, ' ');\r\n      }\r\n    );\r\n\r\n    // Add a header\r\n    body = '// DO NOT ADD COMMENTS IN THIS FILE.'\r\n      + '  They will be lost when the Rush tool resaves it.\\n' + body;\r\n\r\n    FileSystem.writeFile(this._jsonFilename, body, {\r\n      convertLineEndings: NewlineKind.CrLf\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Helper function only used by the constructor when loading the file.\r\n   */\r\n  private _addItemJson(itemJson: IApprovedPackagesItemJson, jsonFilename: string): void {\r\n    if (this._itemsByName.has(itemJson.name)) {\r\n      throw new Error(`Error loading package review file ${jsonFilename}:` + os.EOL\r\n        + ` the name \"${itemJson.name}\" appears more than once`);\r\n    }\r\n\r\n    const item: ApprovedPackagesItem = new ApprovedPackagesItem();\r\n    item.packageName = itemJson.name;\r\n    if (itemJson.allowedCategories) {\r\n      for (const allowedCategory of itemJson.allowedCategories) {\r\n        item.allowedCategories.add(allowedCategory);\r\n      }\r\n    }\r\n    this._addItem(item);\r\n  }\r\n\r\n  /**\r\n   * Helper function that adds an already created ApprovedPackagesItem to the\r\n   * list and set.\r\n   */\r\n  private _addItem(item: ApprovedPackagesItem): void {\r\n    if (this._itemsByName.has(item.packageName)) {\r\n      throw new InternalError('Duplicate key');\r\n    }\r\n    this.items.push(item);\r\n    this._itemsByName.set(item.packageName, item);\r\n  }\r\n}\r\n"]}