import * as tslib_1 from "tslib";
import { override, virtual } from '@microsoft/decorators';
import { BaseComponent } from '@microsoft/sp-component-base';
import { Guid, UrlQueryParameterCollection, Validate, _SPEventManager, _SPKillSwitch, _SPFlight } from '@microsoft/sp-core-library';
import { _QosMonitor } from '@microsoft/sp-diagnostics';
import { _SPLoaderFlights } from '@microsoft/sp-loader';
import { isEqual, get } from '@microsoft/sp-lodash-subset';
import { SuiteNavManager, SuiteNavManagerConfiguration } from '@ms/sp-suite-nav';
import { loadTheme, registerOnThemeChangeCallback, removeOnThemeChangeCallback, getTheme, DefaultEffects } from '@ms/uifabric-styling-bundle';
import { makeSemanticColorsFromPalette } from './LegacyFabric6Function';
import BaseApplicationContext from './BaseApplicationContext';
import AadPlaceholderManager from './frameworkPlaceholders/AadPlaceholderManager';
import * as loadThemedStyles from '@ms/sp-load-themed-styles';
import SPThemeProvider from './pageChrome/SPThemeProvider';
import { ApplicationLoadType } from './ApplicationLoadType';
import { Flights } from './common/Flights';
import ApplicationManager from './ApplicationManager';
var SUITE_NAV_USE_SPO_BEHAVIOR_KILL_SWITCH = Guid.parse('22F8084E-9DEB-4642-B63E-E70A7F87C998');
var USE_FABRIC_6_THEME_KILL_SWITCH = Guid.parse('daea60a7-5d4b-4c49-b79c-22ace7a63d5c');
var INJECT_GLOBAL_SETTINGS_KILL_SWITCH = Guid.parse('ced512a8-994b-4218-89b5-9e6b861bcd92');
// Qos constants
var loadQosScenarioName = 'BaseApplication.load';
var renderQosScenarioName = 'BaseApplication.render';
var unloadQosScenarioName = 'BaseApplication.unload';
// tslint:disable-next-line: no-any
function addChangeCallback(object, propertyName, onChange) {
    var hiddenPropertyName = "_sp_workaround" + propertyName;
    object[hiddenPropertyName] = object[propertyName];
    Object.defineProperty(object, propertyName, {
        set: function (value) {
            object[hiddenPropertyName] = value;
            if (onChange) {
                onChange(object[hiddenPropertyName]);
            }
        },
        get: function () { return object[hiddenPropertyName]; }
    });
}
/**
 * This is the system base class for client-side applications.  It manages the overall
 * life cycle of your application, and is the first entry point for your code to start
 * executing when the page loads.  The two main events are onLoad() which occurs first,
 * and onRender() which occurs after the application manager has initialized the environment
 * and completed rendering the page chrome.
 *
 * @alpha
 */
var BaseApplication = /** @class */ (function (_super) {
    tslib_1.__extends(BaseApplication, _super);
    function BaseApplication() {
        var _this = _super.call(this) || this;
        _this._handleThemeChange = function (changedTheme) {
            var expectedSemanticColors = tslib_1.__assign({}, changedTheme.semanticColors, makeSemanticColorsFromPalette(changedTheme.palette, false, false));
            if (!isEqual(changedTheme.semanticColors, expectedSemanticColors)
                || !isEqual(changedTheme.effects, DefaultEffects)) {
                loadTheme(tslib_1.__assign({}, changedTheme, { semanticColors: expectedSemanticColors, effects: tslib_1.__assign({}, changedTheme.effects, DefaultEffects) }));
            }
        };
        // tslint:disable-next-line:no-string-literal
        _this['__type'] = 'BaseApplication';
        if (!_SPKillSwitch.isActivated(INJECT_GLOBAL_SETTINGS_KILL_SWITCH, '11/23/2019', 'InjectFabricGlobalSettings')) {
            addChangeCallback(get(window, '__globalSettings__'), 'customizations', function (value) { return _this._handleThemeChange(value.settings.theme); });
            addChangeCallback(get(window, '__globalSettings__.customizations'), 'settings', function (value) { return _this._handleThemeChange(value.theme); });
            addChangeCallback(get(window, '__globalSettings__.customizations.settings'), 'theme', function (value) { return _this._handleThemeChange(value); });
        }
        return _this;
    }
    Object.defineProperty(BaseApplication.prototype, "domElement", {
        /**
         * Returns the DOM element where the application is expected to render its content.
         * The domElement will be undefined until the onRender() event occurs.
         *
         * @remarks
         * IMPORTANT: The application should not access DOM elements outside of this subtree,
         * as they are system-defined and may change over time.
         *
         * Throws an error if the domElement is undefined.
         */
        get: function () {
            Validate.isNotNullOrUndefined(this.context, 'context');
            Validate.isNotDisposed(this.context, 'context');
            Validate.isNotNullOrUndefined(this.context.chrome, 'chrome');
            Validate.isNotDisposed(this.context.chrome, 'chrome');
            return this.context.chrome.appDiv;
        },
        set: function (value) {
            throw new Error('The property cannot be assigned because it is read-only');
        },
        enumerable: true,
        configurable: true
    });
    /**
     * RESERVED FOR INTERNAL USAGE. This method is invoked automatically by the application manager.
     * The application code should not call it directly.
     *
     * @internal
     */
    BaseApplication.prototype._load = function (contextParameters) {
        var qosMonitor = new _QosMonitor(loadQosScenarioName);
        try {
            var applicationContext = this._getApplicationContext(contextParameters);
            this._initializeContext(applicationContext);
            var aadPlaceholderManager = new AadPlaceholderManager();
            aadPlaceholderManager.setUpTokenAcquistionFailurePlaceholder(this, this.context.serviceScope);
            return this.onLoad()
                .then(function () {
                qosMonitor.writeSuccess();
            }).catch(function (e) {
                qosMonitor.writeExpectedFailure('onLoadFailure', e);
                throw e;
            });
        }
        catch (error) {
            qosMonitor.writeUnexpectedFailure('SyncError', error);
            return Promise.reject(error);
        }
    };
    /**
     * RESERVED FOR INTERNAL USAGE. This method is invoked automatically by the application manager
     * to render the application.
     * The application code should not call it directly.
     *
     * @internal
     */
    BaseApplication.prototype._render = function () {
        var qosMonitor = new _QosMonitor(renderQosScenarioName);
        try {
            // We load styles async by default, which is good for performance.
            // At this point in time we want to ensure that all styles in buffer are mounted before
            // rendering the app.
            loadThemedStyles.flush();
            this.context.chrome.show();
            var isFullPageLoad = _SPLoaderFlights._useNewBootSequence() && Flights.useNewChromeSequence() ?
                this.context.loadType === ApplicationLoadType.FullPageLoad :
                true;
            var suiteNavManager = new SuiteNavManager(this.context.chrome.suiteNavDiv, this.context.serviceScope, isFullPageLoad);
            this.context.initializeSuiteNavManager(suiteNavManager);
            var config = this.suiteNavConfiguration();
            if (!config.isSuiteNavDisabled()) {
                var useNewFlow = _SPFlight.isEnabled(1309 /* SPClientSuiteNavCommon */)
                    && config.isSuiteNavLoadingDeferred();
                if (useNewFlow) {
                    suiteNavManager.loadSuiteNavNewFlow(config); // uses new suite nav flow
                }
                else {
                    suiteNavManager.loadSuiteNav(config);
                }
            }
            this.onRender();
            if (Flights.delayExtensionsLoading &&
                !this.context.delayExtensionsLoading &&
                this.context.navigator) {
                this.context.navigator._loadApplicationCustomizers(this.context.preloadedData);
            }
            qosMonitor.writeSuccess();
        }
        catch (error) {
            qosMonitor.writeExpectedFailure('onRenderError', error);
        }
    };
    /**
     * RESERVED FOR INTERNAL USAGE. This method is invoked by the application manager
     * to unload the application. The page chrome is still available at this point
     * The application code should not call it directly.
     *
     * @internal
     */
    BaseApplication.prototype._unload = function () {
        if (!_SPLoaderFlights._useNewBootSequence()) {
            return;
        }
        var qosMonitor = new _QosMonitor(unloadQosScenarioName);
        try {
            this.onUnload();
            qosMonitor.writeSuccess();
        }
        catch (error) {
            qosMonitor.writeExpectedFailure('onUnloadError', error);
        }
    };
    /**
     * RESERVED FOR INTERNAL USAGE. This method is invoked automatically by the application manager
     * to load the application specific theme.
     * The application code should not call it directly.
     *
     * @internal
     */
    BaseApplication.prototype._loadTheme = function () {
        var _this = this;
        // When cleaning up the killswitch, keep the check for isChromelessApplication here and remove the check from
        // other code calling this function
        if (!ApplicationManager._isChromelessApplication(this.componentId)) {
            registerOnThemeChangeCallback(this._handleThemeChange);
            var themeProvider = this._getThemeProvider();
            themeProvider.loadThemedStyles().then(function () {
                if (!_SPKillSwitch.isActivated(USE_FABRIC_6_THEME_KILL_SWITCH, '11/21/2019', 'UseFabric6Theme')) {
                    // Workaround to use fabric 6's theme in fabric 7.
                    // makeSemanticColorsFromPalette is copied from fabric 6's branch.
                    _this._handleThemeChange(getTheme());
                }
            });
        }
    };
    /**
     * RESERVED FOR INTERNAL USAGE.
     * Internal API to dispose the application.
     * See onDispose for more details
     */
    BaseApplication.prototype.dispose = function () {
        if (_SPLoaderFlights._useNewBootSequence() && this.context.chrome) {
            this.context.chrome.hide();
        }
        if (!_SPKillSwitch.isActivated(USE_FABRIC_6_THEME_KILL_SWITCH, '11/21/2019', 'UseFabric6Theme')) {
            removeOnThemeChangeCallback(this._handleThemeChange);
        }
        this.onDispose();
        _super.prototype.dispose.call(this);
    };
    /**
     * Returns browser compatibility information for the application.
     *
     * @remarks
     * The SharePoint Framework tracks browser compatibility for the application and the framework.
     * Taken together, this information will determine the experience for the end user.
     *
     * Implement this method to report the level of support that your application provides for the current web browser.
     * Since the User Agent field is impersonated by various browsers, it’s recommended for the implementation to test
     * individual API features rather than trying to identify specific releases of browsers.
     */
    BaseApplication.prototype.getBrowserCompatibility = function () {
        return {
            supportLevel: 0 /* None */,
            warning: undefined
        };
    };
    /**
     * This virtual function returns the default configuration and can be configured by applications
     * when required.
     */
    BaseApplication.prototype.suiteNavConfiguration = function () {
        var config = new SuiteNavManagerConfiguration(this._getSuiteNavManagerConfigurationData());
        config.updateSuiteNavHeight = this._suiteNavHeightHandler.bind(this);
        return config;
    };
    BaseApplication.prototype.delayExtensionsLoading = function () {
        return Flights.delayExtensionsLoading && this.context.delayExtensionsLoading;
    };
    /**
     * This virtual function returns the default application context and can be configured by applications
     * when required.
     *
     * @internal
     */
    BaseApplication.prototype._getApplicationContext = function (contextParameters) {
        return new BaseApplicationContext(contextParameters);
    };
    /**
     * This virtual function returns the default application theme provider and can be overridden by applications
     * when required.
     *
     * @internal
     */
    BaseApplication.prototype._getThemeProvider = function () {
        return new SPThemeProvider(this.context.serviceScope);
    };
    /**
     * This life cycle event occurs immediately after the application manager has loaded the application,
     * before the DOM is constructed.  Applications can use this event to load scripts
     * or start asynchronous operations that need to occur early in the lifecycle.
     * Inside the onLoad() event, applications may also modify the rendering of various
     * page chrome elements, for example by calling this.context.suiteNav.setComponentVisibility(false).
     */
    BaseApplication.prototype.onLoad = function () {
        // (implemented by subclass)
        return Promise.resolve();
    };
    /**
     * This lifecycle event occurs before hiding the application chrome. At this point the application still has
     * the DOM element available and can perform specific operations before the chrome is hidden from the view-port
     */
    BaseApplication.prototype.onUnload = function () {
        // (implemented by subclass)
    };
    /**
     * This lifecycle event occurs after the application manager has constructed the DOM for the page chrome.
     * At this time, the domElement property will be initialized, and the application can begin
     * rendering its own DOM elements.
     */
    BaseApplication.prototype.onRender = function () {
        // (implemented by subclass)
    };
    /**
     * This API is called at the end of the application lifecycle. It should be used to dispose any local
     * resources (i.e. DOM elements) that the application is holding onto.
     *
     * This API is expected to be called in scenarios like cross-application navigation
     * i.e. the host is transitioning from one application to another and disposes the application that is being
     * transitioned out.
     */
    BaseApplication.prototype.onDispose = function () {
        // (implemented by subclass)
    };
    /**
     * Provides the data necessary to construct an instance of SuiteNavManagerConfiguration
     * @internal
     */
    BaseApplication.prototype._getSuiteNavManagerConfigurationData = function () {
        var pageContext = this.context.pageContext;
        var webTemplateId;
        if (!_SPKillSwitch.isActivated(SUITE_NAV_USE_SPO_BEHAVIOR_KILL_SWITCH, '9/08/2017', 'SuiteNavUseSPOBehaviors')) {
            webTemplateId = pageContext.legacyPageContext.webTemplateId;
        }
        var disableSuiteNavSearchBox = false;
        if (!_SPKillSwitch.isActivated(Guid.parse('E0B09CB0-1731-4AEC-BD7D-5F8EE2A10737'), '10/08/2019', 'Disable suite nav search box based on pagecontext setting')) {
            disableSuiteNavSearchBox = pageContext.legacyPageContext.searchBoxInNavBar === 3 /* Hidden */;
        }
        return {
            currentUICultureName: pageContext.cultureInfo.currentUICultureName,
            disableSuiteNav: this._shouldDisableSuiteNav(),
            settingsData: pageContext.legacyPageContext.MenuData ?
                pageContext.legacyPageContext.MenuData.SettingsData :
                undefined,
            signoutUrl: pageContext.legacyPageContext.MenuData ?
                pageContext.legacyPageContext.MenuData.SignOutUrl :
                undefined,
            siteClientTag: pageContext.legacyPageContext.siteClientTag,
            systemUserKey: pageContext.legacyPageContext.systemUserKey,
            userDisplayName: pageContext.user.displayName,
            webServerRelativeUrl: pageContext.web.serverRelativeUrl,
            webTemplateId: webTemplateId,
            disableSuiteNavSearchBox: disableSuiteNavSearchBox
        };
    };
    /**
     * Causes the navigator to navigate to a new page
     *
     * @remarks
     * This will be removed soon. Please use navigator from application context
     * to invoke public APIs
     */
    BaseApplication.prototype._navigate = function (url, props) {
        var _this = this;
        Validate.isNonemptyString(url, 'url');
        return this.context.navigator.navigate(url, props).then(function (res) {
            // When the flight is off we need to re-load the application customizers after the navigation has happened.
            // This is to map with the behavior for the first-time render of the application
            if (!_SPLoaderFlights._useNewBootSequence()) {
                _this.context.navigator._loadApplicationCustomizers(res.preloadedData);
            }
            return res;
        });
    };
    /**
     * Allows the navigator to reinitialize SPFx components with `_IPreloadedData`.
     *
     * @remarks
     * This will be removed soon. Please use navigator from application context
     * to invoke public APIs
     *
     * Navigation is an async operation but calling this API ignores the promise.
     * This is used by List application to change the context, so the framework will send the appropriate events
     * for the context change, but it doesn't impact the application.
     */
    BaseApplication.prototype._navigateToPreloadedData = function (preloadedData) {
        var _this = this;
        Validate.isNotNullOrUndefined(preloadedData, 'preloadedData');
        this.context.navigator.navigateToPreloadedData(preloadedData).then(function () {
            // When the flight is off we need to re-load the application customizers after the navigation has happened.
            // This is to map with the behavior for the first-time render of the application
            if (!_SPLoaderFlights._useNewBootSequence()) {
                _this.context.navigator._loadApplicationCustomizers(preloadedData);
            }
        });
    };
    /**
     * Invalidates a cached resource by its URL. Any subsequent request for the resource
     * will be fetched from its origin and recached.
     *
     * @param url - URL to invalidate
     *
     * @remarks
     * This will be removed soon. Please use navigator from application context
     * to invoke public APIs
     */
    BaseApplication.prototype._invalidate = function (url) {
        Validate.isNonemptyString(url, 'url');
        return this.context.navigator.invalidate(url);
    };
    /**
     * Raises an event for a layout change.
     */
    BaseApplication.prototype.raiseLayoutChangedEvent = function () {
        _SPEventManager.instance.raiseEvent(BaseApplication._layoutChangedEventName, {});
    };
    BaseApplication.prototype._shouldDisableSuiteNav = function () {
        var urlQueryParams = new UrlQueryParameterCollection(window.location.href);
        return window.location.hostname === 'localhost' ||
            urlQueryParams.getValue('disableSuiteNav') === 'true' ?
            true :
            false;
    };
    /**
     * This is a handler to update Suite Nav container height, when sp-suite-nav wants to update it.
     *
     * @param height - Height of the suite nav bar container to be set.
     */
    BaseApplication.prototype._suiteNavHeightHandler = function (height) {
        if (this.context.chrome) {
            this.context.chrome.changeSuiteNavHeight(height);
        }
    };
    /**
     * SPEvent name for page navigation.
     * @internal
     */
    BaseApplication._navigatedEventName = 'application.navigatedEvent';
    /**
     * SPEvent name for layout changes.
     * @internal
     */
    BaseApplication._layoutChangedEventName = 'application.layoutChangedEvent';
    /**
     * SPEvent name for prefetched data availability.
     * @internal
     */
    BaseApplication._prefetchedDataEventName = 'application.prefetchedDataEvent';
    /**
     * SPEvent name for application pre in-place navigation.
     * @internal
     */
    BaseApplication._onBeforeNavigationEventName = 'application.onBeforeNavigationEventName';
    tslib_1.__decorate([
        override
    ], BaseApplication.prototype, "dispose", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "getBrowserCompatibility", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "suiteNavConfiguration", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "delayExtensionsLoading", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "_getApplicationContext", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "_getThemeProvider", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "onLoad", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "onUnload", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "onRender", null);
    tslib_1.__decorate([
        virtual
    ], BaseApplication.prototype, "onDispose", null);
    return BaseApplication;
}(BaseComponent));
export default BaseApplication;
//# sourceMappingURL=BaseApplication.js.map